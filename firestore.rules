rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ====================================
    // üîê HELPER FUNCTIONS
    // ====================================

    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    function getUserData(userId) {
      let userRef = /databases/$(database)/documents/users/$(userId);
      return exists(userRef) ? get(userRef).data : null;
    }

    function isSuperAdmin() {
      let uid = isAuthenticated() ? request.auth.uid : null;
      let email = isAuthenticated() ? request.auth.token.email : null;
      let userData = uid != null ? getUserData(uid) : null;

      return uid != null && (
        uid == 'Ud9bec6d2ea945cf4330a69cb74ac93cf' ||
        email == 'imtthailand2019@gmail.com' ||
        (userData != null && (
          userData.adminRole == 'super_admin' ||
          userData.role == 'super_admin' ||
          userData.isSuperAdmin == true
        ))
      );
    }

    function isAdmin() {
      let uid = isAuthenticated() ? request.auth.uid : null;
      let userData = uid != null ? getUserData(uid) : null;

      return uid != null && (
        (userData != null && (
          userData.role == 'admin' ||
          userData.adminRole == 'admin' ||
          userData.adminRole == 'super_admin'
        )) || isSuperAdmin()
      );
    }

    // ====================================
    // üìä USERS COLLECTION
    // ====================================
    match /users/{userId} {
      // ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏î‡πâ: ‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠ Admin
      allow read: if isOwner(userId) || isAdmin();

      // ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÑ‡∏î‡πâ: ‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á (‡∏™‡∏£‡πâ‡∏≤‡∏á/‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á)
      allow create: if isOwner(userId);
      allow update: if isOwner(userId) || isAdmin();

      // ‡∏•‡∏ö‡πÑ‡∏î‡πâ: Super Admin ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
      allow delete: if isSuperAdmin();
    }

    // ====================================
    // üí¨ SUPER ADMIN CHATS COLLECTION
    // ====================================
    match /super_admin_chats/{sessionId} {
      // ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏î‡πâ: Super Admin (‡∏ó‡∏∏‡∏Å session ‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á)
      allow read: if isSuperAdmin();

      // ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÑ‡∏î‡πâ: Super Admin
      allow create: if isSuperAdmin();
      allow update: if isSuperAdmin();

      // ‡∏•‡∏ö‡πÑ‡∏î‡πâ: Super Admin
      allow delete: if isSuperAdmin();

      // Messages subcollection
      match /messages/{messageId} {
        // ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏î‡πâ: Super Admin
        allow read: if isSuperAdmin();

        // ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÑ‡∏î‡πâ: Super Admin
        allow create: if isSuperAdmin();
        allow update: if isSuperAdmin();

        // ‡∏•‡∏ö‡πÑ‡∏î‡πâ: Super Admin
        allow delete: if isSuperAdmin();
      }
    }

    // ====================================
    // üë• LINE USERS COLLECTION
    // ====================================
    match /line_users/{lineUserId} {
      // ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏î‡πâ: Super Admin ‡πÅ‡∏•‡∏∞ Admin
      allow read: if isAdmin();

      // ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÑ‡∏î‡πâ: Super Admin ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
      allow create, update: if isSuperAdmin();

      // ‡∏•‡∏ö‡πÑ‡∏î‡πâ: Super Admin ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
      allow delete: if isSuperAdmin();
    }

    // ====================================
    // üß† CONVERSATION MEMORY COLLECTION
    // ====================================
    match /conversation_memory/{memoryId} {
      // ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏î‡πâ: Super Admin
      allow read: if isSuperAdmin();

      // ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÑ‡∏î‡πâ: Super Admin
      allow create, update: if isSuperAdmin();

      // ‡∏•‡∏ö‡πÑ‡∏î‡πâ: Super Admin
      allow delete: if isSuperAdmin();
    }

    // ====================================
    // üé• VIDEOS COLLECTION
    // ====================================
    match /videos/{videoId} {
      // ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏î‡πâ: ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô
      allow read: if isAuthenticated();

      // ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÑ‡∏î‡πâ: Admin ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
      allow create, update: if isAdmin();

      // ‡∏•‡∏ö‡πÑ‡∏î‡πâ: Admin ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
      allow delete: if isAdmin();
    }

    // ====================================
    // üìù ADMIN LOGS COLLECTION
    // ====================================
    match /admin_logs/{logId} {
      // ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏î‡πâ: Admin ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
      allow read: if isAdmin();

      // ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÑ‡∏î‡πâ: Admin ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
      allow create: if isAdmin();

      // ‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ update ‡∏´‡∏£‡∏∑‡∏≠ delete logs
      allow update, delete: if false;
    }

    // ====================================
    // üö® USER REPORTS COLLECTION
    // ====================================
    match /user_reports/{reportId} {
      // ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏î‡πâ: Admin ‡πÅ‡∏•‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô
      allow read: if isAdmin() || (isAuthenticated() && resource.data.reportedBy == request.auth.uid);

      // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏î‡πâ: ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏µ‡πà‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô
      allow create: if isAuthenticated() && request.resource.data.reportedBy == request.auth.uid;

      // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÑ‡∏î‡πâ: Admin ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
      allow update: if isAdmin();

      // ‡∏•‡∏ö‡πÑ‡∏î‡πâ: Admin ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
      allow delete: if isAdmin();
    }

    // ====================================
    // üíæ AI MEMORY COLLECTION (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Super Admin)
    // ====================================
    match /ai_memory/{memoryId} {
      // ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏î‡πâ: Super Admin ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
      allow read: if isSuperAdmin();

      // ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÑ‡∏î‡πâ: Super Admin ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
      allow create, update, delete: if isSuperAdmin();
    }

    // ====================================
    // üìä ANALYTICS COLLECTION
    // ====================================
    match /analytics/{docId} {
      // ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏î‡πâ: Admin ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
      allow read: if isAdmin();

      // ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÑ‡∏î‡πâ: System only (‡∏à‡∏≤‡∏Å Cloud Functions)
      allow create, update: if false;

      // ‡∏•‡∏ö‡πÑ‡∏î‡πâ: Super Admin ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
      allow delete: if isSuperAdmin();
    }

    // ====================================
    // üîî NOTIFICATIONS COLLECTION
    // ====================================
    match /notifications/{notificationId} {
      // ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏î‡πâ: ‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠ Admin
      allow read: if isAuthenticated() && (
        resource.data.userId == request.auth.uid || isAdmin()
      );

      // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏î‡πâ: Admin ‡∏´‡∏£‡∏∑‡∏≠ System
      allow create: if isAdmin();

      // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÑ‡∏î‡πâ: ‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö mark as read) ‡∏´‡∏£‡∏∑‡∏≠ Admin
      allow update: if isAuthenticated() && (
        resource.data.userId == request.auth.uid || isAdmin()
      );

      // ‡∏•‡∏ö‡πÑ‡∏î‡πâ: Admin ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
      allow delete: if isAdmin();
    }

    // ====================================
    // ‚öôÔ∏è SETTINGS COLLECTION
    // ====================================
    match /settings/{settingId} {
      // ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏î‡πâ: ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô
      allow read: if isAuthenticated();

      // ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÑ‡∏î‡πâ: Super Admin ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
      allow create, update, delete: if isSuperAdmin();
    }

    // ====================================
    // ‚≠ê FEEDBACK COLLECTION
    // ====================================
    match /feedback/{feedbackId} {
      // Allow reading for admins
      allow read: if isAdmin();
      // Allow creating from Cloud Functions (no auth) or authenticated users
      allow create: if true; // Cloud Functions ‡∏à‡∏∞‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏°‡∏µ auth
      // Allow update/delete for admins only
      allow update, delete: if isAdmin();
    }

    // ====================================
    // ÔøΩ TRAINING SYSTEM COLLECTIONS
    // ====================================
    
    // Training Users
    match /training_users/{userId} {
      allow read: if isAuthenticated();
      allow create: if isOwner(userId);
      allow update: if isOwner(userId) || isAdmin();
      allow delete: if isAdmin();
    }
    
    // Training Courses
    match /training_courses/{courseId} {
      allow read: if resource.data.isPublished == true || isAdmin();
      allow create, update: if isAdmin();
      allow delete: if isAdmin();
    }
    
    // Training Modules
    match /training_modules/{moduleId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAdmin();
    }
    
    // Training Lessons
    match /training_lessons/{lessonId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAdmin();
    }
    
    // Training Quizzes
    match /training_quizzes/{quizId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAdmin();
    }
    
    // Training Questions
    match /training_questions/{questionId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAdmin();
    }
    
    // Training Quiz Results
    match /training_quiz_results/{resultId} {
      allow read: if isAuthenticated() && (
        resource.data.userId == request.auth.uid || isAdmin()
      );
      allow create: if isAuthenticated() && 
        request.resource.data.userId == request.auth.uid;
      allow update, delete: if false; // Results are immutable
    }
    
    // Training Progress
    match /training_progress/{progressId} {
      allow read: if isAuthenticated() && (
        resource.data.userId == request.auth.uid || isAdmin()
      );
      allow create: if isAuthenticated() && 
        request.resource.data.userId == request.auth.uid;
      allow update: if isAuthenticated() && 
        resource.data.userId == request.auth.uid;
      allow delete: if isAdmin();
    }
    
    // Training Certificates
    match /training_certificates/{certId} {
      allow read: if true; // Public for verification
      allow create: if isAuthenticated();
      allow update: if isAdmin();
      allow delete: if false; // Certificates cannot be deleted
    }
    
    // Training Activity Log
    match /training_activity_log/{logId} {
      allow read: if isAuthenticated() && (
        resource.data.userId == request.auth.uid || isAdmin()
      );
      allow create: if isAuthenticated() && 
        request.resource.data.userId == request.auth.uid;
      allow update, delete: if false; // Logs are immutable
    }

    // ====================================
    // üõí MARKETPLACE COLLECTION
    // ====================================
    match /marketplace_items/{itemId} {
      // ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏î‡πâ: ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô (public marketplace)
      allow read: if true;
      
      // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏î‡πâ: ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏µ‡πà‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô
      allow create: if isAuthenticated();
      
      // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÑ‡∏î‡πâ: ‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠ Admin
      allow update: if isAuthenticated() && (
        resource.data.sellerId == request.auth.uid || isAdmin()
      );
      
      // ‡∏•‡∏ö‡πÑ‡∏î‡πâ: ‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠ Admin
      allow delete: if isAuthenticated() && (
        resource.data.sellerId == request.auth.uid || isAdmin()
      );
    }

    // Marketplace Categories
    match /marketplace_categories/{categoryId} {
      allow read: if true;  // Public
      allow create, update, delete: if isAdmin();
    }

    // Marketplace Stats
    match /marketplace_stats/{statId} {
      allow read: if true;  // Public stats
      allow create, update: if isAdmin();
      allow delete: if isSuperAdmin();
    }

    // ====================================
    // üéÅ AI POST USAGE TRACKING
    // ====================================
    match /ai_post_usage/{userId} {
      // ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏î‡πâ: Admin ‡πÅ‡∏•‡∏∞ Cloud Functions
      allow read: if isAdmin();
      
      // ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÑ‡∏î‡πâ: Cloud Functions ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô (‡∏ú‡πà‡∏≤‡∏ô service account)
      allow create, update: if false; // Cloud Functions will use admin SDK
      
      // ‡∏•‡∏ö‡πÑ‡∏î‡πâ: Admin ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
      allow delete: if isAdmin();
    }

    // ====================================
    // üõí USER MARKETPLACE STATES
    // ====================================
    match /user_marketplace_states/{userId} {
      // Cloud Functions access only
      allow read, write: if false;
    }

    // ====================================    // üìù USER ACTIVITY LOGS (WEB)
    // ====================================
    match /user_activity/{activityId} {
      allow read: if isAuthenticated() && (
        resource.data.userId == request.auth.uid || isAdmin()
      );
      allow create: if isAuthenticated() && 
        request.resource.data.userId == request.auth.uid;
      allow update, delete: if false;
    }

    // ====================================    // ÔøΩüö´ DEFAULT RULE - DENY ALL
    // ====================================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
