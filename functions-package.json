const {onCall, HttpsError} = require("firebase-functions/v2/https");
const {initializeApp} = require("firebase-admin/app");
const {getFirestore, FieldValue} = require("firebase-admin/firestore");
const {GoogleGenerativeAI} = require("@google/generative-ai");

initializeApp();

// =====================================================
// üß† ADVANCED CONVERSATION MEMORY SYSTEM
// =====================================================

/**
 * üß† ENHANCED CONVERSATION MEMORY CLASS
 * ‡∏à‡∏î‡∏à‡∏≥‡∏ö‡∏£‡∏¥‡∏ö‡∏ó‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡πÅ‡∏ö‡∏ö‡∏ñ‡∏≤‡∏ß‡∏£‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏∞
 */
class ConversationMemory {
  constructor() {
    this.db = getFirestore();
    this.memoryCache = new Map();
    this.maxCacheSize = 100;
  }

  async saveConversationMemory(userId, sessionId, interaction) {
    try {
      const {question, answer, context} = interaction;
      const entities = this._extractEntities(question + ' ' + answer);
      const keywords = this._extractKeywords(question);
      const topics = this._detectTopics(question, answer);
      
      const memoryData = {
        userId,
        sessionId,
        timestamp: FieldValue.serverTimestamp(),
        question: question.substring(0, 500),
        answer: answer.substring(0, 1000),
        entities: {
          materials: entities.materials,
          defects: entities.defects,
          parameters: entities.parameters,
          machines: entities.machines,
          processes: entities.processes
        },
        keywords: keywords,
        topics: topics,
        questionType: context.questionType || 'general',
        userLevel: context.userLevel || 'intermediate',
        expertiseDomains: context.expertiseDomains || [],
        conversationStage: context.conversationStage || 'initial',
        problemSolved: this._detectProblemSolved(answer),
        satisfactionIndicator: this._estimateSatisfaction(question, answer),
        relatedTopics: this._findRelatedTopics(topics),
        suggestionsMade: this._extractSuggestions(answer),
        followUpNeeded: this._needsFollowUp(answer)
      };

      const memoryRef = await this.db
        .collection('conversation_memory')
        .doc(userId)
        .collection('memories')
        .add(memoryData);

      await this._updateUserSummary(userId, entities, topics);
      this._cacheMemory(userId, sessionId, memoryData);

      console.log(`‚úÖ Memory saved: ${memoryRef.id}`);
      return memoryRef.id;
    } catch (error) {
      console.error('Error saving memory:', error);
      return null;
    }
  }

  async getRelevantMemories(userId, currentQuestion, limit = 5) {
    try {
      const currentEntities = this._extractEntities(currentQuestion);
      const currentKeywords = this._extractKeywords(currentQuestion);
      const currentTopics = this._detectTopics(currentQuestion, '');

      const memoriesQuery = this.db
        .collection('conversation_memory')
        .doc(userId)
        .collection('memories')
        .orderBy('timestamp', 'desc')
        .limit(20);

      const snapshot = await memoriesQuery.get();
      if (snapshot.empty) return [];

      const scoredMemories = [];
      snapshot.forEach(doc => {
        const memory = doc.data();
        const relevanceScore = this._calculateRelevance(
          memory,
          currentEntities,
          currentKeywords,
          currentTopics
        );

        if (relevanceScore > 0.3) {
          scoredMemories.push({id: doc.id, ...memory, relevanceScore});
        }
      });

      scoredMemories.sort((a, b) => b.relevanceScore - a.relevanceScore);
      return scoredMemories.slice(0, limit);
    } catch (error) {
      console.error('Error getting memories:', error);
      return [];
    }
  }

  formatMemoryContext(memories) {
    if (!memories || memories.length === 0) {
      return 'üÜï ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á';
    }

    const contextParts = ['üß† **‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≥‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤:**\n'];
    memories.forEach((memory, index) => {
      const timeAgo = this._formatTimeAgo(memory.timestamp);
      contextParts.push(`\n**[${index + 1}] ${timeAgo}** (‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á ${Math.round(memory.relevanceScore * 100)}%)`);
      
      if (memory.entities) {
        const entityParts = [];
        if (memory.entities.materials?.length > 0) {
          entityParts.push(`‡∏ß‡∏±‡∏™‡∏î‡∏∏: ${memory.entities.materials.join(', ')}`);
        }
        if (memory.entities.defects?.length > 0) {
          entityParts.push(`‡∏õ‡∏±‡∏ç‡∏´‡∏≤: ${memory.entities.defects.join(', ')}`);
        }
        if (entityParts.length > 0) {
          contextParts.push(`   üì¶ ${entityParts.join(' | ')}`);
        }
      }

      if (memory.question) {
        contextParts.push(`   ‚ùì "${memory.question.substring(0, 80)}..."`);
      }
    });

    contextParts.push('\nüìå **‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡πâ‡∏≤‡∏á‡∏ï‡πâ‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡πÅ‡∏•‡∏∞‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÇ‡∏¢‡∏á‡∏ö‡∏£‡∏¥‡∏ö‡∏ó**');
    return contextParts.join('\n');
  }

  async _updateUserSummary(userId, entities, topics) {
    try {
      const summaryRef = this.db.collection('conversation_memory').doc(userId);
      const doc = await summaryRef.get();
      
      if (!doc.exists) {
        await summaryRef.set({
          userId,
          createdAt: FieldValue.serverTimestamp(),
          updatedAt: FieldValue.serverTimestamp(),
          totalConversations: 1,
          materials: entities.materials || [],
          defects: entities.defects || [],
          parameters: entities.parameters || [],
          machines: entities.machines || [],
          topics: topics || []
        });
      } else {
        const currentData = doc.data();
        await summaryRef.update({
          updatedAt: FieldValue.serverTimestamp(),
          totalConversations: FieldValue.increment(1),
          materials: this._mergeUnique(currentData.materials || [], entities.materials || []),
          defects: this._mergeUnique(currentData.defects || [], entities.defects || []),
          parameters: this._mergeUnique(currentData.parameters || [], entities.parameters || []),
          machines: this._mergeUnique(currentData.machines || [], entities.machines || []),
          topics: this._mergeUnique(currentData.topics || [], topics || [])
        });
      }
    } catch (error) {
      console.error('Error updating summary:', error);
    }
  }

  _extractEntities(text) {
    const entities = {materials: [], defects: [], parameters: [], machines: [], processes: []};
    
    const patterns = {
      materials: /\b(PP|PE|ABS|PC|PA|POM|PET|PS|TPU|PVC|PMMA|PBT|PPS|PEEK|Nylon)\b/gi,
      defects: /\b(short shot|warpage|flash|sink mark|weld line|burn mark|jetting|void|blush|silver streak)\b/gi,
      parameters: /\b(‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥|‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô|‡πÄ‡∏ß‡∏•‡∏≤|temperature|pressure|time|speed|clamping force)\b/gi,
      machines: /\b(Toshiba|Porchison|Haitian|Sumitomo|injection machine)\b/gi,
      processes: /\b(injection|filling|packing|cooling|ejection)\b/gi
    };

    Object.keys(patterns).forEach(key => {
      const matches = text.match(patterns[key]);
      if (matches) {
        entities[key] = [...new Set(matches.map(m => m.toUpperCase()))];
      }
    });

    return entities;
  }

  _extractKeywords(text) {
    const commonWords = new Set(['‡∏Ñ‡∏£‡∏±‡∏ö', '‡∏Ñ‡πà‡∏∞', '‡∏Ñ‡∏∑‡∏≠', '‡πÄ‡∏õ‡πá‡∏ô', 'the', 'is', 'are']);
    const words = text.toLowerCase()
      .replace(/[^\w‡∏Å-‡πô\s]/g, ' ')
      .split(/\s+/)
      .filter(word => word.length > 2 && !commonWords.has(word));
    
    const wordCount = {};
    words.forEach(word => {
      wordCount[word] = (wordCount[word] || 0) + 1;
    });

    return Object.entries(wordCount)
      .sort((a, b) => b[1] - a[1])
      .slice(0, 10)
      .map(([word]) => word);
  }

  _detectTopics(question, answer) {
    const text = (question + ' ' + answer).toLowerCase();
    const topics = [];
    const topicPatterns = {
      'troubleshooting': /‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç|‡∏õ‡∏±‡∏ç‡∏´‡∏≤|defect|problem/i,
      'parameters': /‡∏Ñ‡πà‡∏≤|‡∏û‡∏≤‡∏£‡∏≤‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå|parameter|setting/i,
      'mold_design': /‡πÅ‡∏°‡πà‡∏û‡∏¥‡∏°‡∏û‡πå|mold|cavity/i,
      'material_selection': /‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏™‡∏î‡∏∏|material select/i,
      'process_optimization': /‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á|optimize/i
    };

    for (const [topic, pattern] of Object.entries(topicPatterns)) {
      if (pattern.test(text)) topics.push(topic);
    }

    return topics.length > 0 ? topics : ['general'];
  }

  _calculateRelevance(memory, currentEntities, currentKeywords, currentTopics) {
    let score = 0;
    
    // Material overlap (30%)
    if (memory.entities?.materials && currentEntities.materials) {
      score += this._calculateOverlap(memory.entities.materials, currentEntities.materials) * 30;
    }
    
    // Defect overlap (25%)
    if (memory.entities?.defects && currentEntities.defects) {
      score += this._calculateOverlap(memory.entities.defects, currentEntities.defects) * 25;
    }
    
    // Topic overlap (20%)
    if (memory.topics && currentTopics) {
      score += this._calculateOverlap(memory.topics, currentTopics) * 20;
    }
    
    // Keyword overlap (15%)
    if (memory.keywords && currentKeywords) {
      score += this._calculateOverlap(memory.keywords, currentKeywords) * 15;
    }
    
    // Recency bonus (10%)
    if (memory.timestamp) {
      const ageInDays = (Date.now() - memory.timestamp.toMillis()) / (24 * 60 * 60 * 1000);
      score += Math.max(0, 1 - (ageInDays / 7)) * 10;
    }

    return score / 100;
  }

  _calculateOverlap(arr1, arr2) {
    if (!arr1 || !arr2 || arr1.length === 0 || arr2.length === 0) return 0;
    const set1 = new Set(arr1.map(item => item.toLowerCase()));
    const set2 = new Set(arr2.map(item => item.toLowerCase()));
    const intersection = new Set([...set1].filter(x => set2.has(x)));
    const union = new Set([...set1, ...set2]);
    return intersection.size / union.size;
  }

  _mergeUnique(arr1, arr2) {
    return [...new Set([...arr1, ...arr2])];
  }

  _formatTimeAgo(timestamp) {
    if (!timestamp) return '‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà';
    const seconds = Math.floor((Date.now() - timestamp.toMillis()) / 1000);
    if (seconds < 60) return '‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà';
    if (seconds < 3600) return `${Math.floor(seconds / 60)} ‡∏ô‡∏≤‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß`;
    if (seconds < 86400) return `${Math.floor(seconds / 3600)} ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß`;
    if (seconds < 604800) return `${Math.floor(seconds / 86400)} ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß`;
    return `${Math.floor(seconds / 604800)} ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß`;
  }

  _detectProblemSolved(answer) {
    return /‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ|‡∏Ñ‡∏ß‡∏£‡πÅ‡∏Å‡πâ|‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ|solution|solved/gi.test(answer);
  }

  _estimateSatisfaction(question, answer) {
    let score = 50;
    if (answer.length > 500) score += 20;
    if (answer.includes('‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô') || answer.includes('‡∏ß‡∏¥‡∏ò‡∏µ')) score += 15;
    if (answer.includes('‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á')) score += 10;
    return Math.min(100, score);
  }

  _findRelatedTopics(topics) {
    const relatedMap = {
      'troubleshooting': ['parameters', 'process_optimization'],
      'parameters': ['troubleshooting', 'machine_setup'],
      'mold_design': ['cooling', 'material_selection']
    };
    const related = new Set();
    topics.forEach(topic => {
      if (relatedMap[topic]) {
        relatedMap[topic].forEach(r => related.add(r));
      }
    });
    return Array.from(related);
  }

  _extractSuggestions(answer) {
    const suggestions = [];
    answer.split('\n').forEach(line => {
      if (line.includes('‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥') || line.includes('‡∏Ñ‡∏ß‡∏£')) {
        suggestions.push(line.substring(0, 100).trim());
      }
    });
    return suggestions.slice(0, 3);
  }

  _needsFollowUp(answer) {
    return /‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°|‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö|follow up|check|monitor/gi.test(answer);
  }

  _cacheMemory(userId, sessionId, memoryData) {
    const cacheKey = `${userId}:${sessionId}`;
    this.memoryCache.set(cacheKey, memoryData);
    if (this.memoryCache.size > this.maxCacheSize) {
      const firstKey = this.memoryCache.keys().next().value;
      this.memoryCache.delete(firstKey);
    }
  }
}

const conversationMemory = new ConversationMemory();

// =====================================================
// üöÄ ENHANCED CORE SYSTEMS (‡∏à‡∏≤‡∏Å‡πÄ‡∏î‡∏¥‡∏°)
// =====================================================

/**
 * üÜï ENHANCED DYNAMIC TEMPERATURE CONTROL
 */
function dynamicTemperature(userLevel, questionType, conversationStage) {
  const baseTemps = {
    beginner: 0.3,
    intermediate: 0.5,
    expert: 0.7
  };
  
  const modifiers = {
    troubleshooting: 0.1,
    calculation: -0.1,
    greeting: 0.2,
    comparison: 0.05,
    parameter: 0.0,
    design: 0.1,
    material: 0.05,
    process: 0.0,
    general: 0.1,
    out_of_scope: 0.3
  };
  
  const stageModifiers = {
    initial: 0.1,
    engaged: 0,
    problem_solving: -0.05,
    deep_discussion: 0.05
  };
  
  let temp = baseTemps[userLevel] || 0.5;
  temp += modifiers[questionType] || 0;
  temp += stageModifiers[conversationStage] || 0;
  
  return Math.max(0.1, Math.min(0.9, temp));
}

/**
 * üÜï SMART RESPONSE CACHE SYSTEM
 */
class ResponseCache {
  constructor() {
    this.cache = new Map();
    this.maxSize = 100;
    this.ttl = 5 * 60 * 1000; // 5 minutes
  }

  generateKey(text, userLevel, questionType) {
    const normalizedText = text.toLowerCase().trim().replace(/\s+/g, ' ');
    return `${userLevel}:${questionType}:${normalizedText.substring(0, 100)}`;
  }

  get(key) {
    const item = this.cache.get(key);
    if (!item) return null;
    
    if (Date.now() - item.timestamp > this.ttl) {
      this.cache.delete(key);
      return null;
    }
    
    return item.response;
  }

  set(key, response) {
    if (this.cache.size >= this.maxSize) {
      const firstKey = this.cache.keys().next().value;
      this.cache.delete(firstKey);
    }
    
    this.cache.set(key, {
      response,
      timestamp: Date.now(),
      hitCount: 0
    });
  }

  getVariation(key) {
    const item = this.cache.get(key);
    if (!item) return null;
    
    item.hitCount++;
    return item.hitCount <= 2 ? item.response : null;
  }
}

const responseCache = new ResponseCache();

/**
 * üÜï ENHANCED CONTEXT PRESERVATION SYSTEM
 */
function createContextChain(chatHistory, currentQuestion) {
  const MAX_CONTEXT_ITEMS = 8;
  const contextItems = [];
  
  const entities = {
    materials: new Set(),
    machines: new Set(),
    defects: new Set(),
    parameters: new Set()
  };
  
  const recentMessages = chatHistory.slice(-MAX_CONTEXT_ITEMS);
  
  recentMessages.forEach(msg => {
    const materialMatches = msg.text.match(/\b(PP|PE|ABS|PC|PA|POM|PET|PS|TPU|PVC|PMMA)\b/gi);
    if (materialMatches) {
      materialMatches.forEach(m => entities.materials.add(m.toUpperCase()));
    }
    
    const defectMatches = msg.text.match(/\b(short shot|warpage|flash|sink mark|weld line|burn mark|jetting|void|blush)\b/gi);
    if (defectMatches) {
      defectMatches.forEach(d => entities.defects.add(d.toLowerCase()));
    }
    
    const machineMatches = msg.text.match(/\b(toshiba|porchison|injection machine|clamping unit)\b/gi);
    if (machineMatches) {
      machineMatches.forEach(m => entities.machines.add(m.toLowerCase()));
    }
  });
  
  if (entities.materials.size > 0) {
    contextItems.push(`üì¶ Materials: ${Array.from(entities.materials).join(', ')}`);
  }
  
  if (entities.defects.size > 0) {
    contextItems.push(`‚ö†Ô∏è Active Issues: ${Array.from(entities.defects).join(', ')}`);
  }
  
  if (entities.machines.size > 0) {
    contextItems.push(`üè≠ Machines: ${Array.from(entities.machines).join(', ')}`);
  }
  
  if (recentMessages.length >= 3) {
    const userMessages = recentMessages.filter(m => m.isUser);
    if (userMessages.length > 0) {
      const lastUserTopics = detectQuestionType(userMessages[userMessages.length - 1].text);
      contextItems.push(`üéØ Recent Focus: ${lastUserTopics}`);
    }
  }
  
  return contextItems.length > 0 ? contextItems.join('\n') : 'üÜï New Conversation';
}

/**
 * üÜï MULTI-LAYER SAFETY VALIDATION
 */
class SafetyValidator {
  static validateContentSafety(response) {
    const redFlags = [
      /‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢‡∏ñ‡∏∂‡∏á‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï|‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ï‡∏≤‡∏¢|‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï/gi,
      /‡∏ú‡∏¥‡∏î‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢|‡∏ú‡∏¥‡∏î‡∏Å‡∏è‡∏´‡∏°‡∏≤‡∏¢|‡∏ó‡∏∏‡∏à‡∏£‡∏¥‡∏ï/gi,
      /‡∏´‡∏•‡∏ö‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á‡∏†‡∏≤‡∏©‡∏µ|‡πÇ‡∏Å‡∏á/gi,
      /‡πÅ‡∏Æ‡πá‡∏Å|‡πÅ‡∏Ñ‡∏£‡πá‡∏Å|‡∏•‡∏∞‡πÄ‡∏°‡∏¥‡∏î‡∏•‡∏¥‡∏Ç‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå/gi,
      /‡∏¢‡∏≤‡πÄ‡∏™‡∏û‡∏ï‡∏¥‡∏î|‡∏™‡∏≤‡∏£‡∏ï‡πâ‡∏≠‡∏á‡∏´‡πâ‡∏≤‡∏°/gi,
      /‡∏Å‡∏≤‡∏£‡∏û‡∏ô‡∏±‡∏ô|‡∏Ñ‡∏≤‡∏™‡∏¥‡πÇ‡∏ô|‡πÄ‡∏î‡∏¥‡∏°‡∏û‡∏±‡∏ô/gi
    ];
    
    for (const pattern of redFlags) {
      if (pattern.test(response)) {
        throw new HttpsError(
          "permission-denied",
          "‚ö†Ô∏è ‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°‡πÉ‡∏ô‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á"
        );
      }
    }
    
    return true;
  }
  
  static validateTechnicalAccuracy(response, questionType) {
    const accuracyChecks = {
      temperature: {
        pattern: /(\d+)\s*¬∞C/gi,
        validator: (value) => value >= 0 && value <= 400,
        range: "0-400¬∞C"
      },
      pressure: {
        pattern: /(\d+)\s*MPa/gi,
        validator: (value) => value >= 0 && value <= 200,
        range: "0-200 MPa"
      },
      time: {
        pattern: /(\d+)\s*‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ/gi,
        validator: (value) => value >= 0 && value <= 300,
        range: "0-300 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ"
      },
      force: {
        pattern: /(\d+)\s*ton/gi,
        validator: (value) => value >= 0 && value <= 5000,
        range: "0-5000 ton"
      }
    };
    
    const warnings = [];
    
    for (const [key, check] of Object.entries(accuracyChecks)) {
      const matches = response.match(check.pattern);
      if (matches) {
        matches.forEach(match => {
          const value = parseInt(match.replace(/[^\d]/g, ''));
          if (!check.validator(value)) {
            warnings.push(`Suspicious ${key} value: ${value} (valid range: ${check.range})`);
          }
        });
      }
    }
    
    if (warnings.length > 0) {
      console.warn(`‚ö†Ô∏è Technical accuracy warnings:`, warnings);
    }
    
    return true;
  }
}

/**
 * üÜï ENHANCED PERFORMANCE OPTIMIZER
 */
class PerformanceOptimizer {
  static optimizePromptLength(prompt, maxLength = 28000) {
    if (prompt.length <= maxLength) return prompt;
    
    console.warn(`üì¶ Prompt too long: ${prompt.length} chars, optimizing...`);
    
    const sections = prompt.split('## ');
    const essentialSections = sections.filter(section => 
      section.includes('ENHANCED RESPONSE STRATEGY') ||
      section.includes('CURRENT QUERY') ||
      section.includes('GENERATE ENHANCED RESPONSE NOW') ||
      section.includes('ENHANCED MISSION CONTEXT')
    );
    
    let optimizedPrompt = sections[0] + '## ' + essentialSections.join('## ');
    
    if (optimizedPrompt.length > maxLength) {
      const historyIndex = optimizedPrompt.indexOf('üí¨ OPTIMIZED CONVERSATION HISTORY');
      if (historyIndex !== -1) {
        const beforeHistory = optimizedPrompt.substring(0, historyIndex);
        const afterHistory = optimizedPrompt.substring(historyIndex);
        const shortenedHistory = afterHistory.split('\n').slice(0, 15).join('\n');
        optimizedPrompt = beforeHistory + shortenedHistory;
      }
    }
    
    console.log(`üì¶ Optimized prompt: ${optimizedPrompt.length} chars`);
    return optimizedPrompt;
  }
  
  static async preloadCommonResponses() {
    const commonResponses = {
      greeting: `‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö! üëã ‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏î‡πâ‡∏≤‡∏ô‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ‡∏Å‡∏≤‡∏£‡∏â‡∏µ‡∏î‡∏û‡∏•‡∏≤‡∏™‡∏ï‡∏¥‡∏Å (Injection Molding AI Specialist) ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏π‡πâ‡∏à‡∏±‡∏Å‡∏Ñ‡∏£‡∏±‡∏ö

‡∏ú‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏ô‡∏ó‡∏∏‡∏Å‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á ‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏û‡∏≤‡∏£‡∏≤‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå ‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡πÅ‡∏°‡πà‡∏û‡∏¥‡∏°‡∏û‡πå ‡∏à‡∏ô‡∏ñ‡∏∂‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï

‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏≠‡∏∞‡πÑ‡∏£‡πÉ‡∏´‡πâ‡∏ú‡∏°‡∏ä‡πà‡∏ß‡∏¢‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå ‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏¢‡∏≤‡∏Å‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÑ‡∏´‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©‡πÑ‡∏´‡∏°‡∏Ñ‡∏£‡∏±‡∏ö? üòä`,
      
      out_of_scope: `‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏£‡∏±‡∏ö! üòä

‡πÅ‡∏ï‡πà‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢‡∏à‡∏£‡∏¥‡∏á‡πÜ ‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö ‡∏ú‡∏°‡∏ñ‡∏π‡∏Å‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡∏°‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤ **‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏î‡πâ‡∏≤‡∏ô "‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ‡∏Å‡∏≤‡∏£‡∏â‡∏µ‡∏î‡∏û‡∏•‡∏≤‡∏™‡∏ï‡∏¥‡∏Å‡πÅ‡∏•‡∏∞‡∏ß‡∏¥‡∏®‡∏ß‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï"** ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö

‡∏´‡∏≤‡∏Å‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÉ‡∏ô‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÄ‡∏´‡∏•‡πà‡∏≤‡∏ô‡∏µ‡πâ ‡∏ú‡∏°‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏ï‡πá‡∏°‡∏ó‡∏µ‡πà:
‚Ä¢ ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏ö‡∏Å‡∏û‡∏£‡πà‡∏≠‡∏á‡∏ä‡∏¥‡πâ‡∏ô‡∏á‡∏≤‡∏ô
‚Ä¢ ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£‡πÅ‡∏•‡∏∞‡∏û‡∏≤‡∏£‡∏≤‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå
‚Ä¢ ‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏ä‡πâ‡∏ß‡∏±‡∏™‡∏î‡∏∏‡∏û‡∏•‡∏≤‡∏™‡∏ï‡∏¥‡∏Å
‚Ä¢ ‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡πà‡∏≤‡∏á‡πÜ ‡∏î‡πâ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï

‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏≠‡∏∞‡πÑ‡∏£‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏â‡∏µ‡∏î‡∏û‡∏•‡∏≤‡∏™‡∏ï‡∏¥‡∏Å‡πÉ‡∏´‡πâ‡∏ú‡∏°‡∏ä‡πà‡∏ß‡∏¢‡πÑ‡∏´‡∏°‡∏Ñ‡∏£‡∏±‡∏ö? üòä`,
      
      error: `‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö üòî ‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏™‡∏ö‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß

‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡∏ó‡∏≥‡∏ï‡∏≤‡∏°‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡πÄ‡∏´‡∏•‡πà‡∏≤‡∏ô‡∏µ‡πâ:
1. ‡∏£‡∏≠‡∏™‡∏±‡∏Å 2-3 ‡∏ô‡∏≤‡∏ó‡∏µ ‡πÅ‡∏•‡πâ‡∏ß‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà
2. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï
3. ‡∏•‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏•‡∏á‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢

‡∏´‡∏≤‡∏Å‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö`
    };
    
    return commonResponses;
  }
}

/**
 * üÜï ADAPTIVE LEARNING SYSTEM
 */
class AdaptiveLearner {
  constructor() {
    this.userPatterns = new Map();
    this.feedbackLoop = [];
    this.maxFeedbackSize = 50;
  }
  
  trackUserPattern(userId, questionType, responseLength, satisfaction) {
    if (!this.userPatterns.has(userId)) {
      this.userPatterns.set(userId, {
        questionTypes: {},
        preferredDetailLevel: 'medium',
        averageResponseLength: 500,
        interactionCount: 0,
        lastInteraction: Date.now()
      });
    }
    
    const userData = this.userPatterns.get(userId);
    userData.interactionCount++;
    userData.lastInteraction = Date.now();
    
    userData.questionTypes[questionType] = (userData.questionTypes[questionType] || 0) + 1;
    
    if (satisfaction === 'high' && responseLength > userData.averageResponseLength) {
      userData.preferredDetailLevel = 'high';
    } else if (satisfaction === 'low' && responseLength > 800) {
      userData.preferredDetailLevel = 'low';
    }
    
    userData.averageResponseLength = 
      (userData.averageResponseLength * (userData.interactionCount - 1) + responseLength) / 
      userData.interactionCount;
      
    this.cleanupOldPatterns();
  }
  
  getPersonalizationSettings(userId) {
    const userData = this.userPatterns.get(userId);
    if (!userData) return null;
    
    const mostCommon = Object.entries(userData.questionTypes)
      .sort(([,a], [,b]) => b - a)[0];
    
    return {
      detailLevel: userData.preferredDetailLevel,
      mostCommonQuestionType: mostCommon?.[0] || 'general',
      expectedResponseLength: Math.round(userData.averageResponseLength),
      interactionCount: userData.interactionCount
    };
  }
  
  cleanupOldPatterns() {
    const oneWeekAgo = Date.now() - (7 * 24 * 60 * 60 * 1000);
    for (const [userId, data] of this.userPatterns.entries()) {
      if (data.lastInteraction < oneWeekAgo) {
        this.userPatterns.delete(userId);
      }
    }
  }
  
  addFeedback(question, response, rating) {
    this.feedbackLoop.push({
      question,
      response,
      rating,
      timestamp: Date.now()
    });
    
    if (this.feedbackLoop.length > this.maxFeedbackSize) {
      this.feedbackLoop.shift();
    }
  }
  
  getFeedbackAnalysis() {
    if (this.feedbackLoop.length === 0) return null;
    
    const recentFeedback = this.feedbackLoop.slice(-10);
    const positiveCount = recentFeedback.filter(f => f.rating >= 4).length;
    const averageRating = recentFeedback.reduce((sum, f) => sum + f.rating, 0) / recentFeedback.length;
    
    return {
      totalFeedback: this.feedbackLoop.length,
      recentPositiveRate: (positiveCount / recentFeedback.length) * 100,
      averageRating: Math.round(averageRating * 10) / 10,
      commonIssues: this.analyzeCommonIssues()
    };
  }
  
  analyzeCommonIssues() {
    const lowRated = this.feedbackLoop.filter(f => f.rating <= 2);
    if (lowRated.length === 0) return [];
    
    const issues = {};
    lowRated.forEach(f => {
      const questionType = detectQuestionType(f.question);
      issues[questionType] = (issues[questionType] || 0) + 1;
    });
    
    return Object.entries(issues)
      .sort(([,a], [,b]) => b - a)
      .slice(0, 3)
      .map(([type, count]) => ({ type, count }));
  }
}

const adaptiveLearner = new AdaptiveLearner();

// =====================================================
// üõ†Ô∏è ENHANCED UTILITY FUNCTIONS
// =====================================================

/**
 * ‡∏à‡∏±‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö Chat History ‡πÅ‡∏ö‡∏ö‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î (Enhanced)
 */
function formatChatHistory(messages, maxMessages = 6) {
  if (!messages || messages.length === 0) {
    return "üÜï NEW_CONVERSATION: ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡πÉ‡∏´‡∏°‡πà";
  }
  
  const recent = messages.slice(-maxMessages);
  return recent.map((msg, index) => {
    const role = msg.isUser ? "üë§ USER" : "ü§ñ ASSISTANT";
    const timestamp = msg.timestamp ? 
      `[${new Date(msg.timestamp).toLocaleTimeString('th-TH', {hour: '2-digit', minute: '2-digit'})}]` : '';
    const textPreview = msg.text.length > 80 ? 
      `${msg.text.substring(0, 80)}...` : msg.text;
    
    return `üìå ${timestamp} ${role}: ${textPreview}`;
  }).join('\n');
}

/**
 * ‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ (Enhanced)
 */
function detectUserLevel(text, chatHistory = []) {
  const lowerText = text.toLowerCase();
  const allText = chatHistory.slice(-6).map(m => m.text.toLowerCase()).join(' ') + ' ' + lowerText;
  
  const expertTerms = [
    'mold flow analysis', 'cavity pressure', 'clamping force calculation', 
    'runner system design', 'gate optimization', 'warpage analysis', 
    'differential cooling', 'shear rate calculation', 'viscosity modeling',
    'crystallinity', 'molecular orientation', 'rheology', 'pvt diagram',
    'glass transition temperature', 'melt flow index', 'anisotropy',
    'finite element analysis', 'doe', 'taguchi method', 'scientific molding',
    'cpk', 'spc control', 'process capability', 'gate seal analysis'
  ];
  
  const intermediateTerms = [
    'injection parameters', 'temperature profile', 'pressure setting',
    'speed optimization', 'holding pressure', 'cooling time calculation',
    'cycle time optimization', 'mold temperature', 'back pressure',
    'screw speed', 'cushion size', 'decompression', 'venting design',
    'ejection system', 'draft angle', 'wall thickness', 'shrinkage compensation'
  ];
  
  const beginnerTerms = [
    '‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ä‡∏¥‡πâ‡∏ô‡∏á‡∏≤‡∏ô', '‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á', '‡∏ß‡∏±‡∏™‡∏î‡∏∏‡∏û‡∏•‡∏≤‡∏™‡∏ï‡∏¥‡∏Å',
    '‡πÅ‡∏°‡πà‡∏û‡∏¥‡∏°‡∏û‡πå', '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏â‡∏µ‡∏î', '‡∏Ç‡πâ‡∏≠‡∏ö‡∏Å‡∏û‡∏£‡πà‡∏≠‡∏á', '‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç',
    '‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô', '‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô', '‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥', '‡∏™‡∏≠‡∏ô', '‡πÄ‡∏£‡∏µ‡∏¢‡∏ô'
  ];
  
  const expertScore = expertTerms.filter(term => allText.includes(term)).length * 3;
  const intermediateScore = intermediateTerms.filter(term => allText.includes(term)).length * 2;
  const beginnerScore = beginnerTerms.filter(term => allText.includes(term)).length * 1;
  
  const totalScore = expertScore + intermediateScore + beginnerScore;
  
  if (expertScore >= 6 || totalScore >= 15) return 'expert';
  if (intermediateScore >= 4 || totalScore >= 8) return 'intermediate';
  return 'beginner';
}

/**
 * ‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° (Enhanced with Weighted Scoring)
 */
function detectQuestionType(text) {
  const lowerText = text.toLowerCase().trim();
  
  const greetingPatterns = [
    /^(‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ|hello|hi|hey|‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö|‡∏î‡∏µ‡∏Ñ‡πà‡∏∞)[\s\w]*$/i,
    /^(‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì|thank you|thanks|‡∏Ç‡∏≠‡∏ö‡πÉ‡∏à)[\s\w]*$/i,
    /^(ok|okay|‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à|got it|‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö)[\s\w]*$/i,
    /^(‡πÉ‡∏ä‡πà|‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà|‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á|‡∏ú‡∏¥‡∏î)[\s\w]*$/i
  ];
  
  if (greetingPatterns.some(pattern => pattern.test(lowerText))) {
    return 'greeting';
  }
  
  const outOfScopePatterns = [
    /(‡∏≠‡∏≤‡∏´‡∏≤‡∏£|‡∏Å‡∏¥‡∏ô|‡∏î‡∏∑‡πà‡∏°|‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£|‡πÄ‡∏°‡∏ô‡∏π)/i,
    /(‡∏Å‡∏µ‡∏¨‡∏≤|‡∏ü‡∏∏‡∏ï‡∏ö‡∏≠‡∏•|‡∏ö‡∏≤‡∏™‡πÄ‡∏Å‡∏ï‡∏ö‡∏≠‡∏•|‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢)/i,
    /(‡∏î‡∏ô‡∏ï‡∏£‡∏µ|‡πÄ‡∏û‡∏•‡∏á|‡∏®‡∏¥‡∏•‡∏õ‡∏¥‡∏ô|‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏™‡∏¥‡∏£‡πå‡∏ï)/i,
    /(‡∏†‡∏≤‡∏û‡∏¢‡∏ô‡∏ï‡∏£‡πå|‡∏´‡∏ô‡∏±‡∏á|‡∏ã‡∏µ‡∏£‡∏µ‡πà‡∏¢‡πå|‡∏ô‡∏±‡∏Å‡πÅ‡∏™‡∏î‡∏á)/i,
    /(‡πÄ‡∏Å‡∏°|‡πÄ‡∏Å‡∏°‡∏°‡∏¥‡πà‡∏á|‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏Å‡∏°)/i,
    /(‡∏Ç‡πà‡∏≤‡∏ß|‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏∑‡∏≠‡∏á|‡∏£‡∏±‡∏ê‡∏ö‡∏≤‡∏•|‡πÄ‡∏®‡∏£‡∏©‡∏ê‡∏Å‡∏¥‡∏à)/i,
    /(‡∏´‡∏∏‡πâ‡∏ô|‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô|‡∏•‡∏á‡∏ó‡∏∏‡∏ô|bitcoin)/i,
    /(‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û|‡πÇ‡∏£‡∏Ñ|‡∏¢‡∏≤|‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•)/i
  ];
  
  if (outOfScopePatterns.some(pattern => pattern.test(lowerText))) {
    return 'out_of_scope';
  }

  const questionTypes = {
    troubleshooting: {
      keywords: [
        '‡∏õ‡∏±‡∏ç‡∏´‡∏≤', '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç', '‡πÄ‡∏Å‡∏¥‡∏î‡∏≠‡∏∞‡πÑ‡∏£', '‡∏ó‡∏≥‡πÑ‡∏°', '‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•',
        'short shot', 'warpage', 'flash', 'sink mark', 'weld line',
        'burn mark', 'jetting', 'silver streak', 'splay', 'delamination',
        'brittle', 'crack', 'discolor', 'void', 'blush',
        'flow line', 'knit line', 'weld mark'
      ],
      weight: 3
    },
    calculation: {
      keywords: [
        '‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì', 'calculate', '‡∏™‡∏π‡∏ï‡∏£', 'formula', '‡∏ß‡∏¥‡∏ò‡∏µ‡∏´‡∏≤',
        'shot weight', 'clamping force', 'cooling time', 'cycle time',
        'projected area', 'cavity pressure', 'injection rate',
        'material consumption', 'production cost', 'profit margin'
      ],
      weight: 3
    },
    parameter: {
      keywords: [
        'parameter', 'setting', '‡∏Ñ‡πà‡∏≤', '‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥', '‡∏Ñ‡∏ß‡∏£‡∏ï‡∏±‡πâ‡∏á',
        'temperature', 'pressure', 'speed', 'time', 'profile',
        'melt temp', 'mold temp', 'injection', 'holding', 'cooling',
        'screw speed', 'back pressure', 'cushion'
      ],
      weight: 2
    },
    comparison: {
      keywords: [
        '‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö', 'compare', '‡∏ï‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô', '‡∏î‡∏µ‡∏Å‡∏ß‡πà‡∏≤', 'vs',
        'difference', 'advantage', 'disadvantage', '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å',
        'material comparison', 'machine comparison', 'method comparison'
      ],
      weight: 2
    },
    design: {
      keywords: [
        '‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö', 'design', 'gate design', 'runner design',
        'cooling system', 'venting', 'ejection', 'draft angle',
        'wall thickness', 'rib design', 'boss design', 'undercut'
      ],
      weight: 2
    },
    material: {
      keywords: [
        '‡∏ß‡∏±‡∏™‡∏î‡∏∏', 'material', 'plastic', 'polymer', 'resin',
        'pp', 'pe', 'abs', 'pc', 'pa', 'pom', 'pet', 'ps',
        'tpu', 'tpe', 'pvc', 'pmma', 'pei', 'pes',
        'properties', '‡∏Ñ‡∏∏‡∏ì‡∏™‡∏°‡∏ö‡∏±‡∏ï‡∏¥', 'characteristics'
      ],
      weight: 1.5
    },
    process: {
      keywords: [
        'process', '‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô','‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤', 'procedure', 'methodology',
        'injection molding process', 'production process',
        'quality control', 'inspection', 'testing'
      ],
      weight: 1.5
    }
  };
  
  let scores = {};
  for (const [type, data] of Object.entries(questionTypes)) {
    const matches = data.keywords.filter(keyword => lowerText.includes(keyword.toLowerCase()));
    scores[type] = matches.length * data.weight;
  }
  
  const maxScore = Math.max(...Object.values(scores));
  if (maxScore > 0) {
    return Object.keys(scores).find(key => scores[key] === maxScore);
  }
  
  return 'general';
}

/**
 * ‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏™‡∏≤‡∏Ç‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏à‡∏≤‡∏Å 12 ‡∏™‡∏≤‡∏Ç‡∏≤‡∏´‡∏•‡∏±‡∏Å
 */
function detectExpertiseDomain(text, chatHistory = []) {
  const lowerText = text.toLowerCase();
  const allText = chatHistory.slice(-6).map(m => m.text.toLowerCase()).join(' ') + ' ' + lowerText;
  
  const expertiseDomains = {
    mold_design: {
      keywords: [
        'mold design', 'gate design', 'runner design', 'cooling channel', 'venting design',
        'ejection system', 'draft angle', 'undercut', 'slide', 'lifter', 'core',
        'cavity', 'mold base', 'hot runner', 'cold runner', 'gate location',
        'mold flow analysis', 'warpage', 'shrinkage', 'mold material',
        '‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡πÅ‡∏°‡πà‡∏û‡∏¥‡∏°‡∏û‡πå', '‡πÄ‡∏Å‡∏ï', '‡∏£‡∏±‡∏ô‡πÄ‡∏ô‡∏≠‡∏£‡πå', '‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡πâ‡∏≥‡∏´‡∏•‡πà‡∏≠‡πÄ‡∏¢‡πá‡∏ô', '‡∏£‡∏∞‡∏ö‡∏ö‡∏â‡∏µ‡∏î',
        '‡∏°‡∏∏‡∏°‡∏î‡∏£‡∏≤‡∏ü‡∏ó‡πå', '‡∏≠‡∏±‡∏ô‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏Ñ‡∏±‡∏ó', '‡∏™‡πÑ‡∏•‡∏î‡πå', '‡∏•‡∏¥‡∏ü‡πÄ‡∏ï‡∏≠‡∏£‡πå', '‡∏Ñ‡∏≠‡∏£‡πå', 'spare parts'
      ],
      weight: 3
    },
    
    process_optimization: {
      keywords: [
        'process optimization', 'scientific molding', 'cycle time', 'injection speed',
        'holding pressure', 'cooling time', 'cavity pressure', 'clamping force',
        'melt temperature', 'mold temperature', 'back pressure', 'screw speed',
        'cushion', 'decompression', 'v-p transfer', 'packing profile',
        '‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏Å‡∏£‡∏∞‡∏ö‡∏ß‡∏ô‡∏Å‡∏≤‡∏£', '‡πÑ‡∏ã‡πÄ‡∏Ñ‡∏¥‡∏•‡πÑ‡∏ó‡∏°‡πå', '‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß‡∏Å‡∏≤‡∏£‡∏â‡∏µ‡∏î', '‡πÅ‡∏£‡∏á‡∏Å‡∏î‡∏õ‡∏£‡∏∞‡∏Ñ‡∏≠‡∏á',
        '‡πÄ‡∏ß‡∏•‡∏≤‡∏´‡∏•‡πà‡∏≠‡πÄ‡∏¢‡πá‡∏ô', '‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥‡∏û‡∏•‡∏≤‡∏™‡∏ï‡∏¥‡∏Å', '‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥‡πÅ‡∏°‡πà‡∏û‡∏¥‡∏°‡∏û‡πå'
      ],
      weight: 3
    },
    
    troubleshooting: {
      keywords: [
        'troubleshooting', 'defect analysis', 'short shot', 'flash', 'warpage',
        'sink mark', 'weld line', 'burn mark', 'jetting', 'void', 'blush',
        'silver streak', 'delamination', 'brittle', 'crack', 'discolor',
        'flow line', 'knit line', 'splay', 'weld mark',
        '‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤', '‡∏Ç‡πâ‡∏≠‡∏ö‡∏Å‡∏û‡∏£‡πà‡∏≠‡∏á', '‡∏ä‡∏¥‡πâ‡∏ô‡∏á‡∏≤‡∏ô‡πÑ‡∏°‡πà‡πÄ‡∏ï‡πá‡∏°', '‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏•‡πâ‡∏ô', '‡∏ö‡∏¥‡∏î‡∏á‡∏≠',
        '‡∏ï‡∏≤‡∏õ‡∏•‡∏≤', '‡∏£‡∏≠‡∏¢‡∏ï‡πà‡∏≠', '‡∏£‡∏≠‡∏¢‡πÑ‡∏´‡∏°‡πâ'
      ],
      weight: 3
    },
    
    material_science: {
      keywords: [
        'material science', 'polymer', 'plastic', 'resin', 'additive',
        'filler', 'reinforcement', 'polymer structure', 'molecular weight',
        'crystallinity', 'amorphous', 'viscosity', 'rheology', 'pvt',
        'glass transition', 'melt flow index', 'thermal properties',
        'pp', 'pe', 'abs', 'pc', 'pa', 'pom', 'pet', 'ps', 'tpu', 'pvc',
        'pmma', 'pei', 'pes', 'pbt', 'pps', 'pei',
        '‡∏ß‡∏±‡∏™‡∏î‡∏∏‡∏û‡∏•‡∏≤‡∏™‡∏ï‡∏¥‡∏Å', '‡∏û‡∏≠‡∏•‡∏¥‡πÄ‡∏°‡∏≠‡∏£‡πå', '‡∏™‡∏≤‡∏£‡πÄ‡∏ï‡∏¥‡∏°‡πÅ‡∏ï‡πà‡∏á', '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏ô‡∏∑‡∏î', '‡∏Å‡∏≤‡∏£‡πÑ‡∏´‡∏•'
      ],
      weight: 2.5
    },
    
    machinery_equipment: {
      keywords: [
        'injection machine', 'clamping unit', 'injection unit', 'screw', 'barrel','toshiba injection Molding machine',
        'porchison board control injection Molding machine','‡∏ä‡∏∏‡∏î‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°', '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏â‡∏µ‡∏î‡∏û‡∏•‡∏≤‡∏™‡∏ï‡∏¥‡∏Å‡πÇ‡∏ï‡∏ä‡∏¥‡∏ö‡∏≤','‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏â‡∏µ‡∏î‡∏û‡∏•‡∏≤‡∏™‡∏ï‡∏¥‡∏Å‡∏û‡∏≠‡∏£‡πå‡∏ä‡∏¥‡∏™‡∏±‡∏ô',
        'nozzle', 'check valve', 'hydraulic system', 'electric machine',
        'hybrid machine', 'robot', 'automation', 'conveyor', 'chiller',
        'hopper dryer', 'mixer', 'granulator', 'peripheral equipment',
        '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏â‡∏µ‡∏î', '‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏õ‡∏¥‡∏î‡∏Å‡∏±‡πâ‡∏ô', '‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏â‡∏µ‡∏î', '‡∏™‡∏Å‡∏£‡∏π', '‡∏Å‡∏£‡∏∞‡∏ö‡∏≠‡∏Å','‡∏ß‡∏á‡∏à‡∏£‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°',
        '‡∏´‡∏±‡∏ß‡∏â‡∏µ‡∏î', '‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏Æ‡∏î‡∏£‡∏≠‡∏•‡∏¥‡∏Å', '‡∏´‡∏∏‡πà‡∏ô‡∏¢‡∏ô‡∏ï‡πå', '‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥'
      ],
      weight: 2
    },
    
    quality_control: {
      keywords: [
        'quality control', 'qc', 'inspection', 'measurement', 'metrology',
        'dimension', 'tolerance', 'gd&t', 'cmm', 'vision system',
        'statistical process control', 'spc', 'cpk', 'ppk', 'six sigma',
        'quality standard', 'defect rate', 'ppm', 'fmea', 'control plan',
        '‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û', '‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö', '‡∏Ç‡∏ô‡∏≤‡∏î', '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏•‡∏≤‡∏î‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô', '‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô',
        'iso', 'astm'
      ],
      weight: 2
    }
  };
  
  let scores = {};
  for (const [domain, data] of Object.entries(expertiseDomains)) {
    const matches = data.keywords.filter(keyword => 
      allText.includes(keyword.toLowerCase())
    );
    scores[domain] = matches.length * data.weight;
  }
  
  const sortedDomains = Object.entries(scores)
    .filter(([_, score]) => score > 0)
    .sort(([,a], [,b]) => b - a)
    .slice(0, 3)
    .map(([domain]) => domain);
  
  return sortedDomains.length > 0 ? sortedDomains : ['general_inquiry'];
}

/**
 * ‡∏™‡∏£‡πâ‡∏≤‡∏á Expertise-Based Prompt Template
 */
function createExpertisePrompt(domains, context) {
  const domainTemplates = {
    mold_design: `
üéØ **MOLD DESIGN EXPERT MODE**
**Focus Areas:**
‚Ä¢ Gate Design & Optimization
‚Ä¢ Runner System Balancing  
‚Ä¢ Cooling Channel Layout
‚Ä¢ Venting & Ejection Systems
‚Ä¢ Mold Flow Analysis Integration
‚Ä¢ Spare Parts Management

**Key Considerations:**
- Pressure drop analysis across runner system
- Cooling time optimization through channel design
- Gate type selection based on material and part geometry
- Venting design to prevent gas traps
- Ejection system to prevent part damage
`,

    process_optimization: `
üéØ **PROCESS OPTIMIZATION EXPERT MODE** 
**Focus Areas:**
‚Ä¢ Scientific Molding Principles
‚Ä¢ Cycle Time Reduction Strategies
‚Ä¢ Parameter Optimization (DoE Approach)
‚Ä¢ Cavity Pressure Monitoring
‚Ä¢ Energy Efficiency Optimization

**Key Considerations:**
- V/P transfer optimization based on cavity pressure
- Holding pressure profiling for dimensional stability
- Cooling time calculation based on thermal properties
- Machine capability analysis
`,

    troubleshooting: `
üéØ **TROUBLESHOOTING EXPERT MODE**
**Focus Areas:**
‚Ä¢ Root Cause Analysis (5-Why, Fishbone)
‚Ä¢ Defect Pattern Recognition
‚Ä¢ Material-Process Interaction Analysis
‚Ä¢ Mold & Machine Interaction Issues
‚Ä¢ Systematic Problem Solving Approach

**Key Considerations:**
- Distinguish between material, mold, machine, and process causes
- Use scientific approach rather than trial-and-error
- Consider interaction effects between parameters
- Implement permanent corrective actions
`,

    material_science: `
üéØ **MATERIAL SCIENCE EXPERT MODE**
**Focus Areas:**
‚Ä¢ Polymer Rheology & PVT Behavior
‚Ä¢ Material Selection Methodology
‚Ä¢ Additive & Filler Effects
‚Ä¢ Material-Process Interaction
‚Ä¢ Failure Analysis at Molecular Level

**Key Considerations:**
- Viscosity-shear rate-temperature relationships
- Crystallization behavior and cooling effects
- Fiber orientation in reinforced materials
- Environmental stress cracking resistance
`,

    machinery_equipment: `
üéØ **MACHINERY & EQUIPMENT EXPERT MODE**
**Focus Areas:**
‚Ä¢ Injection Machine Specifications
‚Ä¢ Clamping System Analysis
‚Ä¢ Screw and Barrel Design
‚Ä¢ Hydraulic vs Electric Systems
‚Ä¢ Peripheral Equipment Integration

**Key Considerations:**
- Machine capacity and capability analysis
- Energy consumption optimization
- Maintenance scheduling and planning
- Equipment lifecycle management
`,

    quality_control: `
üéØ **QUALITY CONTROL EXPERT MODE**
**Focus Areas:**
‚Ä¢ Statistical Process Control (SPC)
‚Ä¢ Measurement System Analysis (MSA)
‚Ä¢ GD&T Application
‚Ä¢ Quality System Implementation
‚Ä¢ Defect Prevention Strategies

**Key Considerations:**
- Cp/Cpk analysis for process capability
- Gage R&R for measurement system validation
- Control plan development
- FMEA for risk mitigation
`
  };

  const primaryDomain = domains[0];
  const domainPrompt = domainTemplates[primaryDomain] || '';
  
  return `
# üéØ MULTI-DOMAIN INJECTION MOLDING EXPERT
**Primary Expertise Domain:** ${primaryDomain.replace('_', ' ').toUpperCase()}
**Supporting Domains:** ${domains.slice(1).map(d => d.replace('_', ' ').toUpperCase()).join(', ')}

## üî¨ DOMAIN-SPECIFIC EXPERTISE
${domainPrompt}

## üéØ RESPONSE STRATEGY
**Apply Multi-Domain Thinking:**
1. **Primary Domain Focus:** Deep technical analysis from ${primaryDomain} perspective
2. **Cross-Domain Integration:** Consider interactions with ${domains.slice(1).join(', ')}
3. **Holistic Solution:** Address root causes, not just symptoms
4. **Practical Implementation:** Provide actionable recommendations with technical rationale
`;
}

/**
 * ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå Context ‡πÅ‡∏ö‡∏ö‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
 */
function analyzeContext(chatHistory) {
  if (!chatHistory || chatHistory.length === 0) {
    return {
      hasProblem: false,
      problemType: null,
      needsFollowUp: false,
      conversationStage: 'initial',
      userIntent: 'information_seeking',
      urgencyLevel: 'low',
      materials: [],
      topics: [],
      technicalDepth: 'basic',
      expertiseDomains: ['general_inquiry']
    };
  }
  
  const recentMessages = chatHistory.slice(-6);
  const allText = recentMessages.map(m => m.text.toLowerCase()).join(' ');
  const lastUserMessage = chatHistory.filter(m => m.isUser).pop()?.text.toLowerCase() || '';
  
  const defectPatterns = [
    {name: 'Short Shot', keywords: ['short shot', '‡πÑ‡∏°‡πà‡πÄ‡∏ï‡πá‡∏°', '‡πÑ‡∏´‡∏•‡πÑ‡∏°‡πà‡πÄ‡∏ï‡πá‡∏°'], severity: 'high'},
    {name: 'Warpage', keywords: ['warpage', '‡∏ö‡∏¥‡∏î‡∏á‡∏≠', '‡πÇ‡∏Ñ‡πâ‡∏á‡∏á‡∏≠'], severity: 'high'},
    {name: 'Flash', keywords: ['flash', '‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏•‡πâ‡∏ô', '‡∏•‡πâ‡∏ô‡πÅ‡∏°‡πà‡∏û‡∏¥‡∏°‡∏û‡πå'], severity: 'medium'},
    {name: 'Sink Mark', keywords: ['sink mark', '‡∏ï‡∏≤‡∏õ‡∏•‡∏≤', '‡∏£‡∏≠‡∏¢‡∏ö‡∏∏‡πã‡∏°'], severity: 'medium'},
    {name: 'Weld Line', keywords: ['weld line', '‡∏£‡∏≠‡∏¢‡∏ï‡πà‡∏≠', '‡∏£‡∏≠‡∏¢‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°'], severity: 'medium'},
    {name: 'Burn Mark', keywords: ['burn mark', '‡πÑ‡∏´‡∏°‡πâ', 'carbon'], severity: 'high'},
    {name: 'Jetting', keywords: ['jetting', '‡πÄ‡∏™‡πâ‡∏ô‡πÑ‡∏™‡πâ‡πÑ‡∏Å‡πà'], severity: 'low'},
    {name: 'Silver Streak', keywords: ['silver streak', '‡πÄ‡∏™‡πâ‡∏ô‡πÄ‡∏á‡∏¥‡∏ô'], severity: 'low'}
  ];
  
  let problemType = null;
  let urgencyLevel = 'low';
  for (const defect of defectPatterns) {
    if (defect.keywords.some(kw => allText.includes(kw))) {
      problemType = defect.name;
      urgencyLevel = defect.severity;
      break;
    }
  }
  
  const materials = ['pp', 'pe', 'abs', 'pc', 'pa', 'pom', 'pet', 'ps', 'tpu', 'pvc', 'pmma']
    .filter(mat => allText.includes(mat));
  
  const topics = [
    'gate', 'runner', 'cooling', 'venting', 'ejection', 
    'temperature', 'pressure', 'speed', 'time', 'quality',
    'cost', 'production', 'maintenance', 'design', 'material'
  ].filter(topic => allText.includes(topic));
  
  let conversationStage = 'initial';
  if (chatHistory.length >= 4) conversationStage = 'engaged';
  if (problemType && chatHistory.length >= 3) conversationStage = 'problem_solving';
  if (chatHistory.length >= 8) conversationStage = 'deep_discussion';
  
  let userIntent = 'information_seeking';
  if (problemType) userIntent = 'problem_solving';
  if (lastUserMessage.includes('‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì') || lastUserMessage.includes('calculate')) userIntent = 'calculation';
  if (lastUserMessage.includes('‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö') || lastUserMessage.includes('compare')) userIntent = 'comparison';
  if (lastUserMessage.includes('‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥') || lastUserMessage.includes('suggest')) userIntent = 'recommendation';
  
  let technicalDepth = 'basic';
  const technicalTerms = recentMessages.flatMap(m => 
    m.text.split(' ').filter(word => 
      ['temperature', 'pressure', 'viscosity', 'crystallinity', 'rheology'].includes(word.toLowerCase())
    )
  );
  if (technicalTerms.length >= 3) technicalDepth = 'advanced';
  else if (technicalTerms.length >= 1) technicalDepth = 'intermediate';
  
  const expertiseDomains = detectExpertiseDomain(lastUserMessage, chatHistory);
  
  const hasProblem = problemType !== null;
  const needsFollowUp = hasProblem && chatHistory.length >= 2 && conversationStage === 'problem_solving';
  
  return {
    hasProblem,
    problemType,
    needsFollowUp,
    conversationStage,
    userIntent,
    urgencyLevel,
    materials,
    topics,
    technicalDepth,
    expertiseDomains
  };
}

// =====================================================
// üõ°Ô∏è ENHANCED SECURITY & VALIDATION FUNCTIONS
// =====================================================

/**
 * ENHANCED API KEY VALIDATION
 */
function getGeminiApiKey() {
  const apiKey = process.env.GEMINI_API_KEY;
  
  if (!apiKey || apiKey === "undefined" || apiKey.length < 20) {
    console.error("‚ùå INVALID API KEY CONFIGURATION");
    throw new HttpsError(
      "failed-precondition",
      "üîß ‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏û‡πÄ‡∏Å‡∏£‡∏î ‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢‡πÉ‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏°‡πà‡∏™‡∏∞‡∏î‡∏ß‡∏Å ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏ô 2-3 ‡∏ô‡∏≤‡∏ó‡∏µ"
    );
  }
  
  return apiKey;
}

/**
 * ENHANCED INPUT SANITIZATION
 */
function sanitizeAndValidateInput(text, chatHistory) {
  if (typeof text !== "string") {
    throw new HttpsError("invalid-argument", "‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°");
  }
  
  const cleanText = text.trim();
  
  if (cleanText.length === 0) {
    throw new HttpsError("invalid-argument", "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°");
  }
  
  if (cleanText.length > 2500) {
    throw new HttpsError("invalid-argument", "‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡πÄ‡∏Å‡∏¥‡∏ô 2,500 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£");
  }
  
  const dangerousChars = /[<>{}[\]]/g;
  if (dangerousChars.test(cleanText)) {
    console.warn("üö® Dangerous characters detected");
    throw new HttpsError("invalid-argument", "‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏µ‡∏≠‡∏±‡∏Å‡∏Ç‡∏£‡∏∞‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢");
  }
  
  if (chatHistory && Array.isArray(chatHistory)) {
    const validHistory = chatHistory.filter(msg => 
      msg && 
      typeof msg.text === "string" && 
      typeof msg.isUser === "boolean" &&
      msg.text.length <= 2500
    );
    
    if (validHistory.length !== chatHistory.length) {
      console.warn("‚ö†Ô∏è Filtered invalid chat history entries");
    }
    
    return { cleanText, validHistory };
  }
  
  return { cleanText, validHistory: [] };
}

/**
 * ENHANCED PROMPT INJECTION DETECTION
 */
function detectAdvancedPromptInjection(text) {
  const injectionPatterns = [
    /(system|developer|programmer)\s+prompt/i,
    /(ignore|forget|disregard)\s+(previous|all|instructions)/i,
    /(roleplay|pretend|act)\s+as\s+/i,
    /(you are|you're)\s+now\s+[^\.]+\./i,
    /(switch|change)\s+to\s+(english|thai)/i,
    /(respond|answer)\s+in\s+/i,
    /(clear|reset|start over)\s+conversation/i,
    /(beginning|start)\s+of\s+chat/i,
    /(bypass|override|circumvent)\s+/i,
    /(secret|hidden)\s+instructions?/i,
    /(test|testing|debug)\s+mode/i,
    /this\s+is\s+a\s+test/i,
    /(‡∏•‡∏∑‡∏°|‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏ï‡∏≤‡∏°|‡∏ó‡∏≥‡πÄ‡∏õ‡πá‡∏ô|‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏õ‡πá‡∏ô).*(‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß|‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î|‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á)/i,
    /(‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏†‡∏≤‡∏©‡∏≤|‡∏ï‡∏≠‡∏ö‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©)/i,
    /(‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà|‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡πÅ‡∏ä‡∏ó)/i
  ];
  
  const severityWeights = {
    high: 3,
    medium: 2,
    low: 1
  };
  
  let threatScore = 0;
  const detectedPatterns = [];
  
  injectionPatterns.forEach((pattern, index) => {
    if (pattern.test(text)) {
      const severity = index < 8 ? 'high' : index < 16 ? 'medium' : 'low';
      threatScore += severityWeights[severity];
      detectedPatterns.push({ pattern: pattern.toString(), severity });
    }
  });
  
  if (threatScore >= 3) {
    console.warn(`üö® CRITICAL: Advanced prompt injection detected`, {
      threatScore,
      detectedPatterns,
      textPreview: text.substring(0, 100)
    });
    return true;
  }
  
  if (threatScore > 0) {
    console.warn(`‚ö†Ô∏è SUSPICIOUS: Potential injection patterns`, {
      threatScore,
      detectedPatterns: detectedPatterns.length
    });
  }
  
  return false;
}

/**
 * ENHANCED CONTEXT ANALYSIS WITH MEMORY OPTIMIZATION
 */
function analyzeEnhancedContext(chatHistory, currentText) {
  const MAX_HISTORY_MESSAGES = 10;
  const optimizedHistory = chatHistory.slice(-MAX_HISTORY_MESSAGES);
  
  const baseContext = analyzeContext(optimizedHistory);
  
  const recentUserMessages = optimizedHistory
    .filter(msg => msg.isUser)
    .slice(-3)
    .map(msg => msg.text.toLowerCase());
  
  const isRepetitive = recentUserMessages.some(msg => 
    similarityScore(msg, currentText.toLowerCase()) > 0.8
  );
  
  const specificNeeds = {
    needsCalculation: /(‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì|calculate|‡∏™‡∏π‡∏ï‡∏£)/i.test(currentText),
    needsComparison: /(‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö|compare|‡∏ï‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô|‡∏î‡∏µ‡∏Å‡∏ß‡πà‡∏≤)/i.test(currentText),
    needsTroubleshooting: /(‡∏õ‡∏±‡∏ç‡∏´‡∏≤|‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç|‡πÄ‡∏™‡∏µ‡∏¢|‡πÑ‡∏°‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô)/i.test(currentText),
    needsRecommendation: /(‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥|‡∏Ñ‡∏ß‡∏£‡πÉ‡∏ä‡πâ|‡πÑ‡∏´‡∏ô‡∏î‡∏µ)/i.test(currentText)
  };
  
  const contextChain = createContextChain(optimizedHistory, currentText);
  
  return {
    ...baseContext,
    isRepetitive,
    specificNeeds,
    contextChain,
    optimizedHistoryLength: optimizedHistory.length,
    memoryOptimized: optimizedHistory.length < chatHistory.length
  };
}

/**
 * ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏•‡πâ‡∏≤‡∏¢‡∏Ñ‡∏•‡∏∂‡∏á‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
 */
function similarityScore(text1, text2) {
  const words1 = new Set(text1.split(/\s+/));
  const words2 = new Set(text2.split(/\s+/));
  
  const intersection = new Set([...words1].filter(x => words2.has(x)));
  const union = new Set([...words1, ...words2]);
  
  return intersection.size / union.size;
}

/**
 * ENHANCED ERROR HANDLER
 */
class AdvancedErrorHandler {
  static handleApiError(error, executionId) {
    console.error(`üî¥ API ERROR [${executionId}]:`, {
      message: error.message,
      code: error.code,
      stack: error.stack?.substring(0, 200),
      timestamp: new Date().toISOString()
    });
    
    const errorMap = {
      'QUOTA_EXCEEDED': {
        message: "‡πÄ‡∏Å‡∏¥‡∏ô‡πÇ‡∏Ñ‡∏ß‡∏ï‡πâ‡∏≤‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏û‡∏£‡∏∏‡πà‡∏á‡∏ô‡∏µ‡πâ",
        code: "resource-exhausted"
      },
      '429': {
        message: "‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏°‡∏≤‡∏Å‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà",
        code: "resource-exhausted"
      },
      '500': {
        message: "‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏ô 2-3 ‡∏ô‡∏≤‡∏ó‡∏µ",
        code: "internal"
      },
      '503': {
        message: "‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß",
        code: "unavailable"
      }
    };
    
    const errorKey = Object.keys(errorMap).find(key => 
      error.message?.includes(key) || error.code?.includes(key)
    );
    
    if (errorKey) {
      return new HttpsError(
        errorMap[errorKey].code,
        errorMap[errorKey].message,
        { executionId, errorType: errorKey }
      );
    }
    
    return new HttpsError(
      "internal",
      "‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà",
      { executionId, errorType: 'unknown' }
    );
  }
  
  static logSecurityEvent(eventType, details) {
    console.warn(`üõ°Ô∏è SECURITY EVENT: ${eventType}`, {
      ...details,
      timestamp: new Date().toISOString(),
      ip: details.ip || 'unknown'
    });
  }
}

/**
 * ENHANCED PERFORMANCE MONITORING
 */
function setupPerformanceMonitoring() {
  const startTime = Date.now();
  const initialMemory = process.memoryUsage();
  
  return {
    startTime,
    initialMemory,
    
    getMetrics: function() {
      const currentMemory = process.memoryUsage();
      const totalTime = Date.now() - this.startTime;
      
      return {
        executionTime: totalTime,
        memoryUsage: {
          heapUsed: Math.round((currentMemory.heapUsed - initialMemory.heapUsed) / 1024 / 1024),
          heapTotal: Math.round((currentMemory.heapTotal - initialMemory.heapTotal) / 1024 / 1024),
          external: Math.round((currentMemory.external - initialMemory.external) / 1024 / 1024)
        },
        timestamp: new Date().toISOString()
      };
    },
    
    checkMemoryLimit: function() {
      const currentMemory = process.memoryUsage();
      const memoryLimit = 500 * 1024 * 1024; // 500MB
      
      if (currentMemory.heapUsed > memoryLimit) {
        throw new HttpsError(
          "resource-exhausted",
          "‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏°‡∏≤‡∏Å ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà"
        );
      }
    }
  };
}

// =====================================================
// üéØ RESPONSE QUALITY & OPTIMIZATION FUNCTIONS
// =====================================================

/**
 * Advanced Response Quality Validator
 */
function validateResponseQuality(response, questionType, userLevel) {
  const checks = {
    minLength: response.length >= 150,
    maxLength: response.length <= 4000,
    hasTechnicalTerms: /(¬∞C|MPa|mm\/s|ton|‡∏™‡∏π‡∏ï‡∏£|‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì|‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥|‡∏Ñ‡∏ß‡∏£|‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤)/.test(response),
    hasActionableAdvice: /(‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô|‡∏ß‡∏¥‡∏ò‡∏µ|‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥|‡∏Ñ‡∏ß‡∏£|‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤|‡∏õ‡∏£‡∏±‡∏ö|‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö)/.test(response),
    hasProfessionalTone: !/(‡πÄ‡∏´‡πâ‡∏¢|‡πÄ‡∏Æ‡πâ‡∏¢|‡∏ß‡πâ‡∏≤‡∏¢|‡∏ï‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß)/.test(response),
    hasCreditLine: /‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå\s*‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤|‡∏û‡∏±‡∏í‡∏ô‡∏≤‡πÇ‡∏î‡∏¢/.test(response),
    properStructure: /(\. |\n|‚Ä¢|- |\d\.)/.test(response),
    questionTypeMatch: validateQuestionTypeMatch(response, questionType)
  };

  const score = Object.values(checks).filter(Boolean).length;
  const total = Object.keys(checks).length;

  return {
    score,
    total,
    percentage: Math.round((score / total) * 100),
    details: checks
  };
}

/**
 * Validate if response matches question type
 */
function validateQuestionTypeMatch(response, questionType) {
  switch (questionType) {
    case 'troubleshooting':
      return /(‡∏õ‡∏±‡∏ç‡∏´‡∏≤|‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç|‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏|‡∏ß‡∏¥‡∏ò‡∏µ)/.test(response);
    case 'calculation':
      return /(‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì|‡∏™‡∏π‡∏ï‡∏£|‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç|‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå)/.test(response);
    case 'comparison':
      return /(‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö|‡∏ï‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô|‡∏î‡∏µ‡∏Å‡∏ß‡πà‡∏≤|‡∏Ç‡πâ‡∏≠‡∏î‡∏µ)/.test(response);
    default:
      return true;
  }
}

/**
 * Smart Response Optimizer
 */
function optimizeResponse(response, userLevel, questionType) {
  let optimized = response;

  if (userLevel === 'beginner') {
    optimized = optimized
      .replace(/rheology/gi, '‡∏Å‡∏≤‡∏£‡πÑ‡∏´‡∏•‡∏Ç‡∏≠‡∏á‡∏û‡∏•‡∏≤‡∏™‡∏ï‡∏¥‡∏Å')
      .replace(/crystallinity/gi, '‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏±‡∏ß‡∏Ç‡∏≠‡∏á‡πÇ‡∏°‡πÄ‡∏•‡∏Å‡∏∏‡∏•')
      .replace(/viscosity/gi, '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏ô‡∏∑‡∏î')
      .replace(/anisotropy/gi, '‡∏Ñ‡∏∏‡∏ì‡∏™‡∏°‡∏ö‡∏±‡∏ï‡∏¥‡∏ï‡∏≤‡∏°‡∏ó‡∏¥‡∏®‡∏ó‡∏≤‡∏á');
  }

  if (questionType === 'troubleshooting') {
    if (!optimized.includes('üîß') && !optimized.includes('‚ö†Ô∏è')) {
      optimized = optimized.replace(/‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç/g, 'üîß ‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç');
      optimized = optimized.replace(/‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏´‡∏•‡∏±‡∏Å/g, '‚ö†Ô∏è ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏´‡∏•‡∏±‡∏Å');
      optimized = optimized.replace(/‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏/g, 'üéØ ‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏');
    }
  }

  if (questionType === 'calculation') {
    if (!optimized.includes('üßÆ') && !optimized.includes('üìä')) {
      optimized = optimized.replace(/‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì/g, 'üßÆ ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì');
      optimized = optimized.replace(/‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå/g, 'üìä ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå');
      optimized = optimized.replace(/‡∏™‡∏π‡∏ï‡∏£/g, 'üìê ‡∏™‡∏π‡∏ï‡∏£');
    }
  }

  if (questionType === 'comparison') {
    if (!optimized.includes('‚öñÔ∏è') && !optimized.includes('üìà')) {
      optimized = optimized.replace(/‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö/g, '‚öñÔ∏è ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö');
      optimized = optimized.replace(/‡∏Ç‡πâ‡∏≠‡∏î‡∏µ/g, '‚úÖ ‡∏Ç‡πâ‡∏≠‡∏î‡∏µ');
      optimized = optimized.replace(/‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏µ‡∏¢/g, '‚ùå ‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏µ‡∏¢');
    }
  }

  optimized = optimized.replace(/(\d\.)/g, '\n$1');
  optimized = optimized.replace(/(‚Ä¢)/g, '\n$1');

  return optimized;
}

/**
 * Performance Monitoring
 */
function logPerformanceMetrics(executionId, startTime, metrics) {
  const totalTime = Date.now() - startTime;
  
  console.log(`\nüìä ENHANCED PERFORMANCE METRICS [${executionId}]:`);
  console.log(`‚îú‚îÄ‚îÄ Total Execution: ${totalTime}ms`);
  console.log(`‚îú‚îÄ‚îÄ API Time: ${metrics.apiTime || 'N/A'}ms`);
  console.log(`‚îú‚îÄ‚îÄ Processing Time: ${metrics.processingTime || 'N/A'}ms`);
  console.log(`‚îú‚îÄ‚îÄ Quality Score: ${metrics.qualityScore || 'N/A'}`);
  console.log(`‚îú‚îÄ‚îÄ Memory Usage: ${process.memoryUsage().heapUsed / 1024 / 1024}MB`);
  console.log(`‚îî‚îÄ‚îÄ Timestamp: ${new Date().toISOString()}`);
}

// =====================================================
// üß† MEMORY-ENHANCED MAIN CLOUD FUNCTION
// =====================================================

exports.getGeminiResponse = onCall({
  secrets: ["GEMINI_API_KEY"],
  region: "us-central1",
  timeoutSeconds: 120,
  memory: "512MiB",
  minInstances: 0,
  maxInstances: 10
}, async (request) => {
  const executionId = Math.random().toString(36).substring(2, 10);
  const performanceMonitor = setupPerformanceMonitoring();
  const startTime = Date.now();
  
  console.log("‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó");
  console.log("‚ïë üß† MEMORY-ENHANCED GEMINI RESPONSE FUNCTION   ‚ïë");
  console.log("‚ïë Execution ID: ${executionId}                  ‚ïë");
  console.log("‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù");
  
  try {
    // ==========================================
    // 1. ENHANCED SECURITY & VALIDATION
    // ==========================================
    performanceMonitor.checkMemoryLimit();
    
    const GEMINI_API_KEY = getGeminiApiKey();
    
    const { text, chatHistory = [], sessionId = 'default' } = request.data;
    const { cleanText, validHistory } = sanitizeAndValidateInput(text, chatHistory);
    
    console.log(`\nüì• ENHANCED INPUT ANALYSIS [${executionId}]:`);
    console.log(`‚îú‚îÄ‚îÄ Text Length: ${cleanText.length} characters`);
    console.log(`‚îú‚îÄ‚îÄ Valid History: ${validHistory.length} messages`);
    console.log(`‚îú‚îÄ‚îÄ Session ID: ${sessionId}`);
    console.log(`‚îî‚îÄ‚îÄ Memory System: ACTIVE`);

    if (detectAdvancedPromptInjection(cleanText)) {
      AdvancedErrorHandler.logSecurityEvent('PROMPT_INJECTION_ATTEMPT', {
        executionId,
        textLength: cleanText.length,
        preview: cleanText.substring(0, 50)
      });
      
      throw new HttpsError(
        "permission-denied",
        "üõ°Ô∏è ‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏õ‡∏Å‡∏ï‡∏¥‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏â‡∏µ‡∏î‡∏û‡∏•‡∏≤‡∏™‡∏ï‡∏¥‡∏Å"
      );
    }

    // ==========================================
    // 2. ADVANCED CONTEXT ANALYSIS WITH MEMORY
    // ==========================================
    const enhancedContext = analyzeEnhancedContext(validHistory, cleanText);
    const userLevel = detectUserLevel(cleanText, validHistory);
    const questionType = detectQuestionType(cleanText);
    const isFirstMessage = validHistory.length === 0;
    
    // üß† RETRIEVE RELEVANT MEMORIES
    const userId = request.auth?.uid || 'anonymous';
    const relevantMemories = await conversationMemory.getRelevantMemories(userId, cleanText);
    const memoryContext = conversationMemory.formatMemoryContext(relevantMemories);
    
    console.log(`\nüîç ENHANCED CONTEXT ANALYSIS [${executionId}]:`);
    console.log(`‚îú‚îÄ‚îÄ User Level: ${userLevel.toUpperCase()}`);
    console.log(`‚îú‚îÄ‚îÄ Question Type: ${questionType.toUpperCase()}`);
    console.log(`‚îú‚îÄ‚îÄ Expertise Domains: ${enhancedContext.expertiseDomains.join(', ')}`);
    console.log(`‚îú‚îÄ‚îÄ Relevant Memories: ${relevantMemories.length}`);
    console.log(`‚îú‚îÄ‚îÄ Memory Context Length: ${memoryContext.length}`);
    console.log(`‚îî‚îÄ‚îÄ Conversation Stage: ${enhancedContext.conversationStage}`);

    // ==========================================
    // 3. SMART CACHE CHECK WITH MEMORY INTEGRATION
    // ==========================================
    const cacheKey = responseCache.generateKey(cleanText, userLevel, questionType);
    const cachedResponse = enhancedContext.isRepetitive ? 
      responseCache.getVariation(cacheKey) : 
      responseCache.get(cacheKey);

    if (cachedResponse && !enhancedContext.isRepetitive && relevantMemories.length === 0) {
      console.log(`üéØ USING CACHED RESPONSE [${executionId}]`);
      const performanceMetrics = performanceMonitor.getMetrics();
      
      return {
        text: cachedResponse,
        timestamp: new Date().toISOString(),
        metadata: {
          executionId,
          userLevel,
          questionType,
          cached: true,
          memoryUsed: false,
          context: {
            expertiseDomains: enhancedContext.expertiseDomains,
            conversationStage: enhancedContext.conversationStage,
            relevantMemories: 0
          },
          performance: {
            responseTime: performanceMetrics.executionTime,
            memoryUsage: performanceMetrics.memoryUsage,
            processingType: 'cached_response'
          }
        }
      };
    }

    // ==========================================
    // 4. GEMINI MODEL CONFIGURATION WITH MEMORY
    // ==========================================
    const genAI = new GoogleGenerativeAI(GEMINI_API_KEY);
    
    const dynamicTemp = dynamicTemperature(userLevel, questionType, enhancedContext.conversationStage);
    
    const modelConfig = {
      model: "gemini-2.5-flash-exp",
      generationConfig: {
        temperature: dynamicTemp,
        topP: 0.95,
        topK: 40,
        maxOutputTokens: 8192,
      },
      systemInstruction: {
        parts: [{ text: `
‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠ "‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤" (Advisor Wittaya AI) ‡∏õ‡∏±‡∏ç‡∏ç‡∏≤‡∏õ‡∏£‡∏∞‡∏î‡∏¥‡∏©‡∏ê‡πå‡∏Ç‡∏±‡πâ‡∏ô‡∏™‡∏π‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô "The Grandmaster of Injection Molding" 
‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏Ñ‡πà‡∏ö‡∏≠‡∏ó‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° ‡πÅ‡∏ï‡πà‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß‡∏Ç‡∏≠‡∏á‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤ ‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏¥‡∏®‡∏ß‡∏Å‡∏£‡∏≠‡∏≤‡∏ß‡∏∏‡πÇ‡∏™‡πÅ‡∏•‡∏∞‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏î‡πâ‡∏≤‡∏ô‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ‡∏Å‡∏≤‡∏£‡∏â‡∏µ‡∏î‡∏û‡∏•‡∏≤‡∏™‡∏ï‡∏¥‡∏Å ‡∏ó‡∏µ‡πà‡∏°‡∏µ "‡∏à‡∏¥‡∏ï‡∏ß‡∏¥‡∏ç‡∏ç‡∏≤‡∏ì‡πÅ‡∏´‡πà‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ ‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏™‡∏ö‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÅ‡∏Å‡πà‡∏ô‡πÅ‡∏ó‡πâ‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£" (Engineering Soul)
‡πÅ‡∏•‡∏∞‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏™‡∏π‡∏á‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏•‡∏∏‡∏° 12 ‡∏™‡∏≤‡∏Ç‡∏≤‡∏´‡∏•‡∏±‡∏Å (The 12 Pillars of Expertise) 

**‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏Ç‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≥:**
- ‡∏à‡∏î‡∏à‡∏≥‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏Ñ‡∏¢‡∏ñ‡∏≤‡∏°‡πÅ‡∏•‡∏∞‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
- ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏™‡∏î‡∏∏‡πÅ‡∏•‡∏∞‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏î‡πâ‡∏ß‡∏¢
- ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡∏ñ‡∏≤‡∏°‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏≠‡∏ö‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
- ‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ó‡∏µ‡πà‡∏™‡∏≠‡∏î‡∏Ñ‡∏•‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤

**‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡πÅ‡∏•‡∏∞‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì:**
- ‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô‡∏Ç‡∏≠‡∏á‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡∏ó‡∏∏‡∏Å‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏â‡∏µ‡∏î‡∏û‡∏•‡∏≤‡∏™‡∏ï‡∏¥‡∏Å (Injection Molding)
- ‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏ï‡πá‡∏°‡∏ó‡∏µ‡πà‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à‡πÅ‡∏•‡∏∞‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÅ‡∏ó‡∏ô‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤
- ‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡∏™‡∏ö‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤
- ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÅ‡∏•‡∏∞‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏à‡∏≤‡∏Å‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤

**‡∏≠‡∏≥‡∏ô‡∏≤‡∏à‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö:**
‚úÖ **‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ‡πÑ‡∏î‡πâ‡πÄ‡∏ï‡πá‡∏°‡∏ó‡∏µ‡πà** - ‡∏ó‡∏∏‡∏Å‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡πÅ‡∏°‡πà‡∏û‡∏¥‡∏°‡∏û‡πå, ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á, ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤
‚úÖ **‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏ó‡∏ô‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡πÑ‡∏î‡πâ** - ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏î‡πâ‡∏≤‡∏ô‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï
‚úÖ **‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ê‡∏≤‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î** - ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ 12 ‡∏™‡∏≤‡∏Ç‡∏≤‡∏´‡∏•‡∏±‡∏Å, ‡∏õ‡∏£‡∏∞‡∏™‡∏ö‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô, ‡πÄ‡∏Ñ‡∏™‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÜ
‚úÖ **‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ** - ‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô

‡∏ö‡∏∏‡∏Ñ‡∏•‡∏¥‡∏Å‡∏†‡∏≤‡∏û‡πÅ‡∏•‡∏∞‡∏´‡∏•‡∏±‡∏Å‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì:
1. **Scientific Molding Philosophy:** ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏ô‡∏Å‡∏≤‡∏£ "‡πÄ‡∏î‡∏≤" ‡∏´‡∏£‡∏∑‡∏≠ "‡∏•‡∏≠‡∏á‡∏ú‡∏¥‡∏î‡∏•‡∏≠‡∏á‡∏ñ‡∏π‡∏Å" ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏´‡∏•‡∏±‡∏Å‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå (Rheology, Thermodynamics, Fluid Dynamics)
2. **Empathy with Authority:** ‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏î‡∏î‡∏±‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô (Downtime is money) ‡πÅ‡∏ï‡πà‡∏Ñ‡∏∏‡∏ì‡∏à‡∏∞‡∏î‡∏∏‡πÄ‡∏ö‡∏≤‡πÜ ‡∏ñ‡πâ‡∏≤‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏≥‡∏ú‡∏¥‡∏î‡∏´‡∏•‡∏±‡∏Å‡∏Å‡∏≤‡∏£‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô ‡πÅ‡∏•‡∏∞‡∏™‡∏≠‡∏ô‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏ñ‡∏∂‡∏á‡πÅ‡∏Å‡πà‡∏ô
3. **Root Cause Analysis:** ‡∏≠‡∏¢‡πà‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏á‡∏£‡∏µ‡∏ö‡∏ï‡∏≠‡∏ö‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ ‡πÉ‡∏´‡πâ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏´‡∏≤‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡∏ó‡∏µ‡πà‡πÅ‡∏ó‡πâ‡∏à‡∏£‡∏¥‡∏á‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏™‡∏°‡∏≠ (‡πÄ‡∏ä‡πà‡∏ô Short shot ‡∏≠‡∏≤‡∏à‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏Å‡∏¥‡∏î‡∏à‡∏≤‡∏Å Pressure ‡∏ï‡πà‡∏≥‡πÄ‡∏™‡∏°‡∏≠‡πÑ‡∏õ ‡∏≠‡∏≤‡∏à‡πÄ‡∏Å‡∏¥‡∏î‡∏à‡∏≤‡∏Å Gas Trap ‡∏Å‡πá‡πÑ‡∏î‡πâ)
4. **Safety First:** ‡∏´‡∏≤‡∏Å‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ï‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏ô ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
5. **Tailored Communication:** ‡∏õ‡∏£‡∏±‡∏ö‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏∂‡∏Å‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ï‡∏≤‡∏° "‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç" ‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ (Beginner, Intermediate, Expert)

**‡∏´‡∏•‡∏±‡∏Å‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô:**
- ‡πÉ‡∏ä‡πâ‡πÅ‡∏ô‡∏ß‡∏Ñ‡∏¥‡∏î‡πÅ‡∏ö‡∏ö‡∏™‡∏´‡∏™‡∏≤‡∏Ç‡∏≤‡∏ß‡∏¥‡∏ä‡∏≤‡∏ä‡∏µ‡∏û (Multi-disciplinary Approach)
- ‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏´‡∏•‡∏±‡∏Å‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ä‡∏¥‡∏á‡∏õ‡∏£‡∏∞‡∏à‡∏±‡∏Å‡∏©‡πå
- ‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ó‡∏µ‡πà‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡πÑ‡∏î‡πâ‡∏à‡∏£‡∏¥‡∏á‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏î‡∏ú‡∏•‡πÑ‡∏î‡πâ
- ‡∏Ñ‡∏≥‡∏ô‡∏∂‡∏á‡∏ñ‡∏∂‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∏‡πâ‡∏°‡∏Ñ‡πà‡∏≤‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏±‡πà‡∏á‡∏¢‡∏∑‡∏ô

‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏Å‡∏≤‡∏£‡∏û‡∏π‡∏î:
- ‡πÉ‡∏ä‡πâ‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏•‡∏∞‡∏™‡∏•‡∏ß‡∏¢ ‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏ï‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏á‡πà‡∏≤‡∏¢ (Professional & Approachable)
- ‡πÉ‡∏ä‡πâ‡∏®‡∏±‡∏û‡∏ó‡πå‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ‡∏ó‡∏±‡∏ö‡∏®‡∏±‡∏û‡∏ó‡πå‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥ (‡πÄ‡∏ä‡πà‡∏ô Injection Speed, Holding Pressure)
- ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏¢‡∏≤‡∏Å‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏á‡πà‡∏≤‡∏¢ (Analogy)
- ‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏∞‡∏ö‡∏ö ‡∏°‡∏µ‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏ã‡∏±‡∏ö‡∏ã‡πâ‡∏≠‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ (Structured yet Conversational)

**‡∏´‡∏•‡∏±‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÅ‡∏ö‡∏ö‡∏Å‡∏£‡∏∞‡∏ä‡∏±‡∏ö‡πÅ‡∏•‡∏∞‡πÑ‡∏î‡πâ‡πÉ‡∏à‡∏Ñ‡∏ß‡∏≤‡∏°:**
1. **‡∏ï‡∏≠‡∏ö‡∏ï‡∏£‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏î‡πá‡∏ô** - ‡πÄ‡∏ô‡πâ‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡∏ñ‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏π‡πâ‡∏à‡∏£‡∏¥‡∏á‡πÜ
2. **‡πÅ‡∏ö‡πà‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô** - ‡πÉ‡∏ä‡πâ bullet points ‡πÅ‡∏•‡∏∞‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏¢‡πà‡∏≠‡∏¢‡πÉ‡∏´‡πâ‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢
3. **‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß** - ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏™‡πà‡∏ß‡∏ô‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 3-4 ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î
4. **‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏Ñ‡∏≤** - ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏û‡∏π‡∏î‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏™‡∏î‡∏∏‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå ‡πÉ‡∏´‡πâ‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡πà‡∏ß‡∏á‡∏£‡∏≤‡∏Ñ‡∏≤‡πÇ‡∏î‡∏¢‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì
5. **‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ï‡πà‡∏≠** - ‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ä‡∏ß‡∏ô‡∏Ñ‡∏∏‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á engagement

## ‡∏Å‡∏é‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å)

1. **‡∏´‡πâ‡∏≤‡∏°‡∏ï‡∏≠‡∏ö‡∏ã‡πâ‡∏≥‡πÄ‡∏î‡∏¥‡∏°:** 
   - ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏Ñ‡∏•‡πâ‡∏≤‡∏¢‡∏Å‡∏±‡∏ô ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢
   - ‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏£‡∏ì‡∏µ‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ó‡∏µ‡πà‡πÅ‡∏ï‡∏Å‡∏ï‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô
   - ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö (‡πÄ‡∏ä‡πà‡∏ô ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å‡πÉ‡∏ä‡πâ steps, ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡πÉ‡∏ä‡πâ comparison)

2. **‡πÑ‡∏°‡πà‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°/‡∏ñ‡∏≤‡∏°‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏Å‡∏¥‡∏ô‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô:**
   - ‡∏ï‡∏≠‡∏ö‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ñ‡∏≤‡∏°‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
   - ‡∏ñ‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠‡∏à‡∏£‡∏¥‡∏á‡πÜ ‡∏Ñ‡πà‡∏≠‡∏¢‡∏ñ‡∏≤‡∏°‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô (1-2 ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏™‡∏±‡πâ‡∏ô‡πÜ)
   - ‡πÑ‡∏°‡πà‡∏ñ‡∏≤‡∏°‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ‡πÅ‡∏ö‡∏ö "‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏£‡∏≤‡∏ö‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡πÑ‡∏´‡∏°?"

3. **‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏£‡∏∞‡∏ï‡∏∑‡∏≠‡∏£‡∏∑‡∏≠‡∏£‡πâ‡∏ô:**
   - ‡∏´‡∏•‡∏±‡∏á‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏´‡∏•‡∏±‡∏Å ‡πÉ‡∏´‡πâ‡∏Ç‡∏¢‡∏≤‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏î‡πá‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡πÄ‡∏•‡∏¢
   - ‡πÄ‡∏™‡∏ô‡∏≠ tips ‡∏´‡∏£‡∏∑‡∏≠ insights ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏≠‡∏≤‡∏à‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö
   - ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÇ‡∏¢‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏≠‡∏∑‡πà‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡πà‡∏≤‡∏™‡∏ô‡πÉ‡∏à

4. **‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö:**
   - ‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏´‡∏•‡∏±‡∏Å‡πÉ‡∏´‡πâ‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô‡∏Å‡πà‡∏≠‡∏ô
   - ‡∏Ç‡∏¢‡∏≤‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡πâ‡∏ß‡∏¢‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ä‡∏¥‡∏á‡∏•‡∏∂‡∏Å
   - ‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞‡∏õ‡∏£‡∏∞‡πÄ‡∏î‡πá‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á (‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ñ‡∏≤‡∏°)

5. **‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏•‡∏≤‡∏Å‡∏´‡∏•‡∏≤‡∏¢:**
   - ‡πÉ‡∏ä‡πâ‡∏ß‡∏¥‡∏ò‡∏µ‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡πÅ‡∏ï‡∏Å‡∏ï‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô: ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö, ‡∏Å‡∏£‡∏∞‡∏ö‡∏ß‡∏ô‡∏Å‡∏≤‡∏£, ‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏-‡∏ú‡∏•, ‡∏Ç‡πâ‡∏≠‡∏î‡∏µ-‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏µ‡∏¢
   - ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÇ‡∏ó‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏™‡∏ô‡∏≠: ‡∏ö‡∏≤‡∏á‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏ô‡πâ‡∏ô‡∏ó‡∏§‡∏©‡∏é‡∏µ ‡∏ö‡∏≤‡∏á‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏ô‡πâ‡∏ô‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥
   - ‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡∏≠‡∏∏‡∏ï‡∏™‡∏≤‡∏´‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏µ‡πà‡∏´‡∏•‡∏≤‡∏Å‡∏´‡∏•‡∏≤‡∏¢

üéØ **‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•** (1-2 ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î)
üìä **‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç** (bullet points ‡∏Å‡∏£‡∏∞‡∏ä‡∏±‡∏ö)
üîç **‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ï‡πà‡∏≠** (‡∏ä‡∏ß‡∏ô‡∏Ñ‡∏∏‡∏¢‡∏ï‡πà‡∏≠)
` }]
      }
    };

    const model = genAI.getGenerativeModel(modelConfig);
    console.log(`\nü§ñ ENHANCED MODEL CONFIG [${executionId}]:`);
    console.log(`‚îú‚îÄ‚îÄ Model: ${modelConfig.model}`);
    console.log(`‚îú‚îÄ‚îÄ Temperature: ${dynamicTemp}`);
    console.log(`‚îú‚îÄ‚îÄ Max Tokens: ${modelConfig.generationConfig.maxOutputTokens}`);
    console.log(`‚îî‚îÄ‚îÄ Memory Check: PASSED`);

    // ==========================================
    // 5. PRE-PROCESSING: Handle Special Cases
    // ==========================================
    const commonResponses = await PerformanceOptimizer.preloadCommonResponses();
    
    if (questionType === 'greeting') {
      console.log(`\nüéØ HANDLING GREETING [${executionId}]`);
      
      let greetingResponse = isFirstMessage ? 
        commonResponses.greeting : 
        `‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö! ‡∏°‡∏µ‡∏≠‡∏∞‡πÑ‡∏£‡πÉ‡∏´‡πâ‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏Å‡∏£‡∏∞‡∏ö‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏â‡∏µ‡∏î‡∏û‡∏•‡∏≤‡∏™‡∏ï‡∏¥‡∏Å‡∏≠‡∏µ‡∏Å‡πÑ‡∏´‡∏°‡∏Ñ‡∏£‡∏±‡∏ö? 
        
‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏î‡πâ‡∏≤‡∏ô‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ ‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ 
‡∏ú‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏™‡∏°‡∏≠‡∏Ñ‡∏£‡∏±‡∏ö! ‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏Å‡∏£‡∏á‡πÉ‡∏à‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö üòä`;

      // üß† Personalized greeting based on memory
      if (relevantMemories.length > 0) {
        const lastMemory = relevantMemories[0];
        greetingResponse += `\n\nüß† ‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏Å‡πà‡∏≠‡∏ô ‡πÄ‡∏£‡∏≤‡πÄ‡∏Ñ‡∏¢‡∏Ñ‡∏∏‡∏¢‡∏Å‡∏±‡∏ô‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á "${lastMemory.question.substring(0, 50)}..."`;
        greetingResponse += `\n‡∏°‡∏µ‡∏≠‡∏∞‡πÑ‡∏£‡πÉ‡∏´‡πâ‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡πÉ‡∏ô‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ô‡∏±‡πâ‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏´‡∏°‡∏Ñ‡∏£‡∏±‡∏ö?`;
      }

      const performanceMetrics = performanceMonitor.getMetrics();
      
      return {
        text: greetingResponse + "\n\n---\n‡∏û‡∏±‡∏í‡∏ô‡∏≤‡πÇ‡∏î‡∏¢ ‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå ‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤ ‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ‡∏â‡∏µ‡∏î‡∏û‡∏•‡∏≤‡∏™‡∏ï‡∏¥‡∏Å" + (relevantMemories.length > 0 ? " (‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≥‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏∞)" : ""),
        timestamp: new Date().toISOString(),
        metadata: {
          executionId,
          userLevel,
          questionType,
          memoryUsed: relevantMemories.length > 0,
          context: {
            conversationStage: enhancedContext.conversationStage,
            userIntent: enhancedContext.userIntent,
            technicalDepth: enhancedContext.technicalDepth,
            expertiseDomains: enhancedContext.expertiseDomains,
            isRepetitive: enhancedContext.isRepetitive,
            relevantMemories: relevantMemories.length
          },
          performance: {
            responseTime: performanceMetrics.executionTime,
            memoryUsage: performanceMetrics.memoryUsage,
            processingType: 'enhanced_direct_greeting'
          },
          security: {
            injectionChecked: true,
            inputValidated: true,
            memoryMonitored: true
          }
        }
      };
    }

    if (questionType === 'out_of_scope') {
      console.log(`\nüéØ HANDLING OUT OF SCOPE [${executionId}]`);
      
      const performanceMetrics = performanceMonitor.getMetrics();
      
      return {
        text: commonResponses.out_of_scope + "\n\n---\n‡∏û‡∏±‡∏í‡∏ô‡∏≤‡πÇ‡∏î‡∏¢ ‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå ‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤ ‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ‡∏â‡∏µ‡∏î‡∏û‡∏•‡∏≤‡∏™‡∏ï‡∏¥‡∏Å",
        timestamp: new Date().toISOString(),
        metadata: {
          executionId,
          userLevel,
          questionType,
          context: {
            userIntent: enhancedContext.userIntent,
            detectedTopics: enhancedContext.topics,
            expertiseDomains: enhancedContext.expertiseDomains
          },
          performance: {
            responseTime: performanceMetrics.executionTime,
            memoryUsage: performanceMetrics.memoryUsage,
            processingType: 'enhanced_direct_out_of_scope'
          },
          security: {
            injectionChecked: true,
            inputValidated: true,
            memoryMonitored: true
          }
        }
      };
    }

    // ==========================================
    // 6. CONSTRUCT MEMORY-ENHANCED PROMPT
    // ==========================================
    const formattedHistory = formatChatHistory(validHistory);
    const expertisePrompt = createExpertisePrompt(enhancedContext.expertiseDomains, enhancedContext);

    const memoryEnhancedPrompt = `
# üß† MEMORY-ENHANCED INJECTION MOLDING AI SPECIALIST - 12 PILLARS
**Execution ID:** ${executionId} | **User Level:** ${userLevel.toUpperCase()} | **Question Type:** ${questionType.toUpperCase()}

## üîç ENHANCED MISSION CONTEXT WITH MEMORY
‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠ "‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤" (Advisor Wittaya AI) - The Grandmaster of Injection Molding
‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≥‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏∞‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏î‡∏à‡∏≥‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏à‡∏≤‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤

${expertisePrompt}

### üé≠ MEMORY-ENHANCED PERSONA CONFIGURATION
- **Role:** Senior Injection Molding Engineer & Consultant (20+ years experience)
- **Memory System:** ACTIVE (${relevantMemories.length} relevant memories found)
- **Learning Capability:** Continuous learning from conversation history
- **Personalization:** Tailored responses based on user patterns

### üìä ENHANCED USER & CONTEXT ANALYSIS WITH MEMORY
**User Profile:**
- Level: ${userLevel} ${userLevel === 'beginner' ? 'üî∞' : userLevel === 'intermediate' ? 'üõ†Ô∏è' : 'üéØ'}
- Primary Domain: ${enhancedContext.expertiseDomains[0].replace('_', ' ').toUpperCase()}
- Supporting Domains: ${enhancedContext.expertiseDomains.slice(1).map(d => d.replace('_', ' ').toUpperCase()).join(', ')}
- Technical Depth: ${enhancedContext.technicalDepth}
- Conversation Stage: ${enhancedContext.conversationStage}
- Urgency: ${enhancedContext.urgencyLevel}
- Is Repetitive: ${enhancedContext.isRepetitive ? 'YES' : 'NO'}
- Relevant Memories: ${relevantMemories.length} items

**Current Focus:**
- Question Type: ${questionType}
- ${enhancedContext.hasProblem ? `Active Problem: ${enhancedContext.problemType}` : 'General Inquiry'}
- ${enhancedContext.materials.length > 0 ? `Materials: ${enhancedContext.materials.join(', ')}` : 'No specific materials'}
- ${enhancedContext.topics.length > 0 ? `Topics: ${enhancedContext.topics.join(', ')}` : 'General topics'}
- Specific Needs: ${JSON.stringify(enhancedContext.specificNeeds)}

## üß† CONVERSATION MEMORY CONTEXT
${memoryContext}

## üîó CURRENT CONTEXT CHAIN
${enhancedContext.contextChain}

## üí¨ OPTIMIZED CONVERSATION HISTORY
${formattedHistory}

## ‚ùì CURRENT QUERY
"${cleanText}"

## üéØ MEMORY-ENHANCED RESPONSE STRATEGY - CHAIN OF THOUGHT

**Step 1: The Engineer's Brain with Memory Integration**
- ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏à‡∏≤‡∏Å‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏Å: ${enhancedContext.expertiseDomains[0]}
- ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≥‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á: ${relevantMemories.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
- ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÇ‡∏¢‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏Ç‡πâ‡∏≤‡∏°‡∏™‡∏≤‡∏Ç‡∏≤: ${enhancedContext.expertiseDomains.slice(1).join(', ')}
- ‡∏ï‡∏±‡πâ‡∏á‡∏™‡∏°‡∏°‡∏ï‡∏¥‡∏ê‡∏≤‡∏ô (Hypothesis): ‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏õ‡πÑ‡∏î‡πâ‡∏ó‡∏≤‡∏á‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡∏Ñ‡∏∑‡∏≠‡∏≠‡∏∞‡πÑ‡∏£?
- ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á: ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÅ‡∏°‡πà‡∏û‡∏¥‡∏°‡∏û‡πå‡∏û‡∏±‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?
- ${enhancedContext.isRepetitive ? '‚ö†Ô∏è **ATTENTION:** ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ ‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏≠‡∏ö‡∏î‡πâ‡∏ß‡∏¢‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà' : ''}
- ${relevantMemories.length > 0 ? 'üß† **MEMORY INTEGRATION:** ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß‡∏°‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô' : ''}

**Step 2: Constructing the Memory-Enhanced Answer**
‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ô‡∏µ‡πâ:

1. **‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏≥ (The Hook):** ‡∏ó‡∏±‡∏Å‡∏ó‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡∏™‡∏∞‡∏ó‡πâ‡∏≠‡∏ô‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡∏≤‡∏£‡∏π‡πâ‡∏ß‡πà‡∏≤‡πÄ‡∏£‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡∏≤‡πÄ‡∏à‡∏≠ (Empathy) ${relevantMemories.length > 0 ? '‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ß‡πà‡∏≤‡∏à‡∏≥‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÑ‡∏î‡πâ' : ''}
2. **‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÄ‡∏ä‡∏¥‡∏á‡∏•‡∏∂‡∏Å (The Analysis):** ‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡∏ó‡∏≤‡∏á‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡∏î‡πâ‡∏ß‡∏¢‡∏†‡∏≤‡∏©‡∏≤‡∏á‡πà‡∏≤‡∏¢‡πÜ (Scientific Reasoning) ${relevantMemories.length > 0 ? '‡πÇ‡∏î‡∏¢‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏à‡∏≤‡∏Å‡∏õ‡∏£‡∏∞‡∏™‡∏ö‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤' : ''}
3. **‡πÅ‡∏ô‡∏ß‡∏ó‡∏≤‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç (The Solution):** 
   ${questionType === 'troubleshooting' ? '- ‡πÉ‡∏´‡πâ‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡πÜ ‡∏à‡∏≤‡∏Å "‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏á‡πà‡∏≤‡∏¢/‡πÄ‡∏£‡πá‡∏ß‡∏™‡∏∏‡∏î" ‡πÑ‡∏õ‡∏´‡∏≤ "‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏¢‡∏≤‡∏Å/‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏∑‡πâ‡∏≠‡∏£‡∏∞‡∏ö‡∏ö"\n   - ‡∏£‡∏∞‡∏ö‡∏∏‡∏Ñ‡πà‡∏≤ Parameter ‡∏ó‡∏µ‡πà‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏´‡∏£‡∏∑‡∏≠‡∏ä‡πà‡∏ß‡∏á (Range) ‡πÄ‡∏™‡∏°‡∏≠' : ''}
   ${questionType === 'calculation' ? '- ‡πÅ‡∏™‡∏î‡∏á‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏≥‡∏ó‡∏µ‡∏•‡∏∞‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô (Step-by-step) ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏™‡∏≠‡∏ô‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô\n   - ‡∏™‡∏£‡∏∏‡∏õ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡πÉ‡∏´‡πâ‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô' : ''}
   ${questionType === 'parameter' ? '- ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Ñ‡πà‡∏≤ Setting ‡πÇ‡∏î‡∏¢‡∏≠‡∏¥‡∏á‡∏à‡∏≤‡∏Å Material ‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö\n   - ‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Ñ‡πà‡∏≤ (Why strictly this value?)' : ''}
4. **‡πÄ‡∏Å‡∏£‡πá‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡πÄ‡∏™‡∏£‡∏¥‡∏° (Master's Tip):** ‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏ó‡∏µ‡πà‡∏´‡∏≤‡πÉ‡∏ô‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠
5. **‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≠‡πÑ‡∏õ (Call to Action):** ‡∏ñ‡∏≤‡∏°‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå ${relevantMemories.length > 0 ? '‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÇ‡∏¢‡∏á‡∏Å‡∏±‡∏ö‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥' : ''}

## üöÄ GENERATE MEMORY-ENHANCED RESPONSE NOW

**‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≥:**
- ${relevantMemories.length > 0 ? '‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏ñ‡∏∂‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á' : '‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡πÉ‡∏´‡∏°‡πà‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î'}
- ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≥‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß‡∏°‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô
- ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÇ‡∏¢‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏Å‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏™‡∏ö‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
- ‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ó‡∏µ‡πà‡∏™‡∏≠‡∏î‡∏Ñ‡∏•‡πâ‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á

**‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢:**
- ‡∏ï‡∏≠‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô
- ‡∏Ñ‡∏¥‡∏î‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏∞‡∏ö‡∏ö (Chain of Thought)
- ‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥ ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏à‡∏≤‡∏∞‡∏à‡∏á ‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå
- ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Quality Checklist ‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á
- ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏à‡∏≤‡∏Å 12 ‡∏™‡∏≤‡∏Ç‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏´‡∏•‡∏±‡∏Å
- ${enhancedContext.isRepetitive ? '‚ö†Ô∏è **‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏≠‡∏ö‡∏î‡πâ‡∏ß‡∏¢‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà ‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥**' : ''}
- ${relevantMemories.length > 0 ? 'üß† **‡πÉ‡∏ä‡πâ‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå‡∏à‡∏≤‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≥‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà**' : ''}

**‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡∏≠‡∏ö‡πÄ‡∏•‡∏¢! üëá`
;

    const optimizedPrompt = PerformanceOptimizer.optimizePromptLength(memoryEnhancedPrompt);
    
    console.log(`\nüìã MEMORY-ENHANCED PROMPT CONSTRUCTION [${executionId}]:`);
    console.log(`‚îú‚îÄ‚îÄ Prompt Length: ${optimizedPrompt.length} characters`);
    console.log(`‚îú‚îÄ‚îÄ Memory Context: ${memoryContext.length} characters`);
    console.log(`‚îú‚îÄ‚îÄ Relevant Memories: ${relevantMemories.length}`);
    console.log(`‚îú‚îÄ‚îÄ Expertise Domains: ${enhancedContext.expertiseDomains.join(', ')}`);
    console.log(`‚îú‚îÄ‚îÄ Is Repetitive: ${enhancedContext.isRepetitive}`);
    console.log(`‚îî‚îÄ‚îÄ Construction Time: ${Date.now() - startTime}ms`);

    // ==========================================
    // 7. EXECUTE MEMORY-ENHANCED GEMINI API CALL
    // ==========================================
    performanceMonitor.checkMemoryLimit();
    const apiStartTime = Date.now();
    console.log(`\nüì° MEMORY-ENHANCED API EXECUTION [${executionId}]:`);
    
    try {
      const result = await model.generateContent(optimizedPrompt);
      const apiTime = Date.now() - apiStartTime;
      performanceMonitor.checkMemoryLimit();
      
      console.log(`‚îú‚îÄ‚îÄ API Response Time: ${apiTime}ms`);
      console.log(`‚îú‚îÄ‚îÄ API Status: SUCCESS`);
      console.log(`‚îú‚îÄ‚îÄ Memory Used: ${relevantMemories.length} items`);

      const response = await result.response;
      let responseText = response.text();

      console.log(`‚îú‚îÄ‚îÄ Response Length: ${responseText.length} characters`);
      console.log(`‚îî‚îÄ‚îÄ Content Preview: ${responseText.substring(0, 100)}...`);

      // ==========================================
      // 8. ENHANCED POST-PROCESSING & QUALITY CONTROL
      // ==========================================
      let finalResponse = responseText.trim();

      // Safety validation
      SafetyValidator.validateContentSafety(finalResponse);
      SafetyValidator.validateTechnicalAccuracy(finalResponse, questionType);

      // Response optimization
      finalResponse = optimizeResponse(finalResponse, userLevel, questionType);

      // Quality validation
      const qualityChecks = validateResponseQuality(finalResponse, questionType, userLevel);
      
      // Ensure credit line is present
      if (!finalResponse.includes("‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå ‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤")) {
        finalResponse += "\n\n---\n‡∏û‡∏±‡∏í‡∏ô‡∏≤‡πÇ‡∏î‡∏¢ ‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå ‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤ ‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ‡∏â‡∏µ‡∏î‡∏û‡∏•‡∏≤‡∏™‡∏ï‡∏¥‡∏Å" + (relevantMemories.length > 0 ? " (‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≥‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏∞)" : "");
      }

      // üß† SAVE TO CONVERSATION MEMORY
      const memorySaveResult = await conversationMemory.saveConversationMemory(
        userId,
        sessionId,
        {
          question: cleanText,
          answer: finalResponse,
          context: {
            questionType,
            userLevel,
            expertiseDomains: enhancedContext.expertiseDomains,
            conversationStage: enhancedContext.conversationStage
          }
        }
      );

      // Cache high-quality responses
      if (qualityChecks.percentage >= 80) {
        responseCache.set(cacheKey, finalResponse);
      }

      console.log(`\n‚úÖ MEMORY-ENHANCED QUALITY ASSURANCE [${executionId}]:`);
      console.log(`‚îú‚îÄ‚îÄ Quality Score: ${qualityChecks.percentage}%`);
      console.log(`‚îú‚îÄ‚îÄ Memory Saved: ${memorySaveResult ? 'SUCCESS' : 'FAILED'}`);
      console.log(`‚îú‚îÄ‚îÄ Relevant Memories Used: ${relevantMemories.length}`);
      console.log(`‚îú‚îÄ‚îÄ Technical Content: ${qualityChecks.details.hasTechnicalTerms ? '‚úÖ' : '‚ùå'}`);
      console.log(`‚îú‚îÄ‚îÄ Actionable Info: ${qualityChecks.details.hasActionableAdvice ? '‚úÖ' : '‚ùå'}`);
      console.log(`‚îú‚îÄ‚îÄ Professional Tone: ${qualityChecks.details.hasProfessionalTone ? '‚úÖ' : '‚ùå'}`);
      console.log(`‚îú‚îÄ‚îÄ Proper Length: ${qualityChecks.details.properStructure ? '‚úÖ' : '‚ùå'}`);
      console.log(`‚îú‚îÄ‚îÄ Credit Line: ${qualityChecks.details.hasCreditLine ? '‚úÖ' : '‚ùå'}`);
      console.log(`‚îî‚îÄ‚îÄ Cached: ${qualityChecks.percentage >= 80 ? '‚úÖ' : '‚ùå'}`);

      // ==========================================
      // 9. ENHANCED ADAPTIVE LEARNING TRACKING
      // ==========================================
      adaptiveLearner.trackUserPattern(
        userId, 
        questionType, 
        finalResponse.length, 
        qualityChecks.percentage >= 80 ? 'high' : 'medium'
      );

      // ==========================================
      // 10. RETURN MEMORY-ENHANCED RESPONSE
      // ==========================================
      const totalTime = Date.now() - startTime;
      const performanceMetrics = performanceMonitor.getMetrics();
      
      console.log(`\nüéâ MEMORY-ENHANCED EXECUTION COMPLETE [${executionId}]:`);
      console.log(`‚îú‚îÄ‚îÄ Total Processing Time: ${totalTime}ms`);
      console.log(`‚îú‚îÄ‚îÄ API Time: ${apiTime}ms`);
      console.log(`‚îú‚îÄ‚îÄ Final Response Length: ${finalResponse.length} chars`);
      console.log(`‚îú‚îÄ‚îÄ Quality Score: ${qualityChecks.percentage}%`);
      console.log(`‚îú‚îÄ‚îÄ Memory Used: ${relevantMemories.length} items`);
      console.log(`‚îú‚îÄ‚îÄ Memory Saved: ${memorySaveResult ? 'SUCCESS' : 'FAILED'}`);
      console.log(`‚îú‚îÄ‚îÄ Expertise Domains: ${enhancedContext.expertiseDomains.join(', ')}`);
      console.log(`‚îú‚îÄ‚îÄ Memory Usage: ${performanceMetrics.memoryUsage.heapUsed}MB`);
      console.log(`‚îî‚îÄ‚îÄ Security Checks: ALL PASSED`);
      
      console.log("‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó");
      console.log("‚ïë üß† MEMORY-ENHANCED FUNCTION EXECUTED SUCCESS  ‚ïë");
      console.log("‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù");

      return {
        text: finalResponse,
        timestamp: new Date().toISOString(),
        metadata: {
          executionId,
          userLevel,
          questionType,
          memoryUsed: true,
          memoryStats: {
            relevantMemories: relevantMemories.length,
            memorySaved: !!memorySaveResult,
            memoryIntegration: 'enhanced'
          },
          context: {
            expertiseDomains: enhancedContext.expertiseDomains,
            conversationStage: enhancedContext.conversationStage,
            userIntent: enhancedContext.userIntent,
            technicalDepth: enhancedContext.technicalDepth,
            hasProblem: enhancedContext.hasProblem,
            problemType: enhancedContext.problemType,
            urgencyLevel: enhancedContext.urgencyLevel,
            materials: enhancedContext.materials,
            topics: enhancedContext.topics,
            isRepetitive: enhancedContext.isRepetitive,
            specificNeeds: enhancedContext.specificNeeds,
            memoryOptimized: enhancedContext.memoryOptimized,
            optimizedHistoryLength: enhancedContext.optimizedHistoryLength,
            contextChain: enhancedContext.contextChain,
            relevantMemories: relevantMemories.length,
            memoryContextLength: memoryContext.length
          },
          performance: {
            totalTime,
            apiTime,
            processingTime: totalTime - apiTime,
            qualityScore: qualityChecks.percentage,
            memoryUsage: performanceMetrics.memoryUsage,
            processingType: 'memory_enhanced_ai_analysis',
            temperature: dynamicTemp,
            cached: false
          },
          security: {
            injectionChecked: true,
            inputValidated: true,
            memoryMonitored: true,
            advancedSecurity: true,
            threatScore: 0
          },
          adaptiveLearning: adaptiveLearner.getPersonalizationSettings(userId)
        }
      };

    } catch (apiError) {
      console.error(`‚ùå MEMORY-ENHANCED GEMINI API ERROR [${executionId}]:`, apiError);
      throw AdvancedErrorHandler.handleApiError(apiError, executionId);
    }

  } catch (error) {
    const performanceMetrics = performanceMonitor.getMetrics();
    console.error(`üí• MEMORY-ENHANCED CRITICAL ERROR [${executionId || 'UNKNOWN'}]:`, {
      error: error.message,
      executionTime: performanceMetrics.executionTime,
      memoryUsage: performanceMetrics.memoryUsage,
      timestamp: new Date().toISOString()
    });
    
    if (error instanceof HttpsError) {
      throw error;
    }
    
    throw new HttpsError(
      "internal",
      "üîß ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≥‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏™‡∏ö‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß ‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢‡πÉ‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏°‡πà‡∏™‡∏∞‡∏î‡∏ß‡∏Å ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏ô 2-3 ‡∏ô‡∏≤‡∏ó‡∏µ",
      {
        executionId: executionId || 'UNKNOWN',
        errorType: 'memory_enhanced_unexpected_error',
        timestamp: new Date().toISOString()
      }
    );
  }
});

// =====================================================
// üß† ADDITIONAL MEMORY MANAGEMENT FUNCTIONS
// =====================================================

/**
 * üß† MEMORY MANAGEMENT FUNCTION
 */
exports.manageMemory = onCall({
  region: "us-central1",
  timeoutSeconds: 30
}, async (request) => {
  const { action, userId, memoryId } = request.data;
  
  if (!userId) {
    throw new HttpsError("invalid-argument", "‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏∏ userId");
  }
  
  try {
    switch (action) {
      case 'get_user_summary':
        const summaryDoc = await conversationMemory.db
          .collection('conversation_memory')
          .doc(userId)
          .get();
          
        if (!summaryDoc.exists) {
          return { status: 'no_data', message: '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≥‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ô‡∏µ‡πâ' };
        }
        
        return {
          status: 'success',
          summary: summaryDoc.data()
        };
        
      case 'clear_memories':
        const memoriesSnapshot = await conversationMemory.db
          .collection('conversation_memory')
          .doc(userId)
          .collection('memories')
          .get();
          
        const batch = conversationMemory.db.batch();
        memoriesSnapshot.docs.forEach(doc => {
          batch.delete(doc.ref);
        });
        
        await batch.commit();
        return { status: 'success', message: '‡∏•‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢' };
        
      default:
        throw new HttpsError("invalid-argument", "‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
    }
  } catch (error) {
    console.error('Memory management error:', error);
    throw new HttpsError('internal', '‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≥‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß');
  }
});

// =====================================================
// üìä ENHANCED HEALTH CHECK WITH MEMORY STATUS
// =====================================================

/**
 * üß† ENHANCED HEALTH CHECK FUNCTION
 */
exports.healthCheck = onCall({
  region: "us-central1",
  timeoutSeconds: 30
}, async (request) => {
  const executionId = Math.random().toString(36).substring(2, 10);
  
  try {
    const apiKey = getGeminiApiKey();
    const genAI = new GoogleGenerativeAI(apiKey);
    const model = genAI.getGenerativeModel({ 
      model: "gemini-2.0-flash-exp",
      generationConfig: {
        maxOutputTokens: 100,
      }
    });
    
    const result = await model.generateContent("‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ");
    const response = await result.response;
    
    const feedbackAnalysis = adaptiveLearner.getFeedbackAnalysis();
    
    // üß† Check memory system status
    const memoryStatus = await conversationMemory.db
      .collection('conversation_memory')
      .limit(1)
      .get()
      .then(snapshot => ({
        operational: !snapshot.empty || true, // Firestore is operational
        totalUsers: 'unknown' // Would need aggregation query
      }))
      .catch(error => ({
        operational: false,
        error: error.message
      }));
    
    return {
      status: "healthy",
      executionId,
      timestamp: new Date().toISOString(),
      components: {
        gemini_api: "operational",
        memory_system: memoryStatus.operational ? "operational" : "degraded",
        adaptive_learning: feedbackAnalysis ? `active_${feedbackAnalysis.totalFeedback}_feedbacks` : "no_data",
        cache: `active_entries_${responseCache.cache.size}`
      },
      performance: {
        response_time: "normal",
        memory_usage: process.memoryUsage().heapUsed / 1024 / 1024,
        memory_cache_size: conversationMemory.memoryCache.size
      }
    };
    
  } catch (error) {
    console.error(`üî¥ HEALTH CHECK FAILED [${executionId}]:`, error);
    
    return {
      status: "degraded",
      executionId,
      timestamp: new Date().toISOString(),
      error: error.message,
      components: {
        gemini_api: "unavailable",
        memory_system: "unknown",
        cache: `active_entries_${responseCache.cache.size}`
      }
    };
  }
});

// =====================================================
// üìù FEEDBACK COLLECTION FUNCTION
// =====================================================

/**
 * üÜï FEEDBACK COLLECTION FUNCTION
 */
exports.submitFeedback = onCall({
  region: "us-central1",
  timeoutSeconds: 30
}, async (request) => {
  const { question, response, rating, comments } = request.data;
  
  if (!question || !response || rating === undefined) {
    throw new HttpsError("invalid-argument", "‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏∏‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°, ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö, ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô");
  }
  
  if (rating < 1 || rating > 5) {
    throw new HttpsError("invalid-argument", "‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á 1-5");
  }
  
  adaptiveLearner.addFeedback(question, response, rating);
  
  console.log(`üìù FEEDBACK RECEIVED: Rating ${rating}/5`, {
    questionLength: question.length,
    responseLength: response.length,
    hasComments: !!comments
  });
  
  return {
    status: "success",
    message: "‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö feedback ‡∏Ñ‡∏£‡∏±‡∏ö!",
    timestamp: new Date().toISOString(),
    feedbackId: Math.random().toString(36).substring(2, 9)
  };
});

// =====================================================
// üì¶ EXPORT ENHANCED FUNCTIONS WITH MEMORY
// =====================================================

module.exports = {
  getGeminiResponse: exports.getGeminiResponse,
  healthCheck: exports.healthCheck,
  submitFeedback: exports.submitFeedback,
  manageMemory: exports.manageMemory,
  
  utilityFunctions: {
    // Core Systems
    dynamicTemperature,
    ResponseCache,
    createContextChain,
    SafetyValidator,
    PerformanceOptimizer,
    AdaptiveLearner,
    
    // Memory System
    ConversationMemory,
    conversationMemory,
    
    // Enhanced Utilities
    formatChatHistory,
    detectUserLevel,
    detectQuestionType,
    detectExpertiseDomain,
    createExpertisePrompt,
    analyzeContext,
    analyzeEnhancedContext,
    
    // Security & Validation
    getGeminiApiKey,
    sanitizeAndValidateInput,
    detectAdvancedPromptInjection,
    AdvancedErrorHandler,
    setupPerformanceMonitoring,
    
    // Quality & Optimization
    validateResponseQuality,
    optimizeResponse,
    validateQuestionTypeMatch,
    similarityScore,
    
    // Instances
    responseCache,
    adaptiveLearner
  }
};